<link rel="import" href="mixins/skp-behavior.html">

<dom-module id="form-skp">
    <template>
        <style include="form-style">
            :host {
                margin: -30px;
            }
            .input-task {
                margin-bottom: 30px;
                background-color: var(--paper-grey-100);
                position: relative;
                border: 1px solid var(--paper-grey-300);
                border-radius: 3px;
            }
            .input-action {
                padding: 8px;
            }
            .input-task paper-input {
                --paper-input-container-underline: { display: none;  };
                --paper-input-container-underline-focus: { display: none;  };
            }
            .input-wrapper {
                background-color: #fff;
                padding: 8px;
                border-bottom: 1px solid var(--paper-grey-300);
                border-radius: 3px 3px 0 0;
            }
            .input-task paper-icon-button {
                position: absolute;
                right: 5px;
                top: 50%;
                margin-top: -20px;
                color: #888;
            }
            .input-task paper-button {
                font-size: 14px;
                font-weight: 400;
                text-transform: none;
                border: 1px solid #ccc;
                padding: 0.3em 0.7em;
            }

            .task-item-text {
                outline: none;
                height: 100%;
                @apply --layout-horizontal;
                @apply --layout-center;
            }

            .tabs {
                position: relative;
                background-color: var(--paper-grey-100);
            }

            .tabs::before {
                content: ' ';
                display: block;
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 1px;
                background-color: #dfdfdf;
            }

            .tabs paper-tabs {
                height: 32px;
                --paper-tabs-scroller-opacity: 0.3;
                --paper-tabs-selection-bar-color: var(--paper-blue-grey-500);
                --paper-tabs-selection-bar: {
                    border-bottom-width: 2px;
                };
            }

            .tabs paper-tab {
                min-width: 100px;
                font-size: 13px;
                text-transform: uppercase;
                
                --paper-tab-ink: var(--paper-blue-grey-500);
            }

            .tabs paper-tab[hidden] {
                display: none;
            }

            .tabs paper-tab::before {
                display: none;
                content: '';
                background-color: #fff;
                position: absolute;
                left: 0;
                right: 0;
                top: 0;
                bottom: 0;
                border: 1px solid #dfdfdf;
                border-width: 0 1px 0 1px;
            }

            .tabs paper-tab.iron-selected::before {
                display: block;
            }

            .tabs paper-tab.iron-selected {
                
            }

            .tabs-content .page {
                display: block;
                padding: 30px;
            }

            .table-responsive {
                position: relative;
                overflow: hidden;
            }

            .table-scroller {
                width: 100%;
                padding-right: 17px; 
                overflow-y: scroll;
                overflow-x: auto;
            }

            .table-scroller > .table {
                table-layout: fixed;
            }

            .table th,
            .table td {
                vertical-align: middle;
                padding: 5px;
            }

            .table tbody tr.header td {
                text-align: center;
                font-weight: 500;
            }

            .table thead,
            .table tbody tr.header {
                border-top: 2px solid #d0d0d0;
                border-bottom: 2px solid #d0d0d0;
            }
            .table tbody tr.group {
                border-top: 2px solid #d0d0d0;
            }
            .table thead tr + tr,
            .table tbody tr + tr {
                border-top: 1px solid #d0d0d0;
            }
            .table tbody {
                border-bottom: 2px solid #d0d0d0;
            }
            .table tbody tr:hover {
                background-color: var(--paper-grey-100);
            }
            .table th + th,
            .table td + td {
                border-left: 1px solid #d0d0d0;
            }

            /*.table td.editable {
                background-color: var(--paper-yellow-100);
            }*/

            .table paper-input,
            .table kct-input-number {
                --paper-input-container: {
                    padding: 0;
                };
                --paper-input-container-input: {
                    text-align: center;
                    padding: 5px 0;
                };
                --paper-input-container-underline: {
                    display: none;
                };
            }

            .table td.readonly {
                background-color: var(--paper-grey-100);
            }

            .table td.editable {
                padding: 1px;
                position: relative;
            }

            .table paper-icon-button {
                padding: 4px;
                width: 30px;
                height: 30px;
            }

            .text-link {
                cursor: pointer;
            }

            .text-link:hover {
                text-decoration: underline;
            }

            kct-checkbox {
                --paper-checkbox-margin: 0;    
            }

            .table tbody tr:hover {
                background: none;
            }

            .form-section {
                margin-bottom: 30px; 
                padding: 20px; 
                border: 1px solid #dfdfdf; 
                border-radius: 3px;
            }
            .form-section h3 {
                font-size: 15px;
                font-weight: 500;
            }
            .form-section paper-button[focused] {
                background-color: var(--paper-green-500);
                @apply --shadow-elevation-2dp;
            }

            .cover {
                border: 1px solid #d0d0d0;
                padding: 30px;
                text-align: center;
                font-family: Cambria, 'Segoe UI', Arial, sans-serif;
            }
            .cover-logo {
                display: inline-block;
                width: 130px;
                height: 130px;
                background-image: url(../../../../images/misc/garuda.jpg);
                background-repeat: no-repeat;
            }
            .cover-headers,
            .cover-subheaders,
            .cover-body {
                margin-bottom: 50px;
            }
            .cover-headers paper-input,
            .cover-footers paper-input {
                --paper-input-container-input: {
                    font-weight: bold;
                    font-size: 20px;
                    font-family: Cambria, 'Segoe UI', Arial, sans-serif;
                };
            }

            .cover-subheaders,
            .cover-body {
                font-size: 16px;
            }
            .cover-subheaders {
                font-weight: bold;
            }
            .cover table {
                margin: auto;
                border-collapse: collapse;
            }
            .cover table td {
                padding: 5px;
                text-align: left;
            }
        </style>

        <kct-ajax id="ajax"></kct-ajax>
        <kct-media screen="{{ screen }}"></kct-media>
        <kct-socket manager="global-socket" on-notify="__onSocketNotify"></kct-socket>

        <div class="tabs" hidden$="[[ phantom ]]">
            <paper-tabs id="tabs" attr-for-selected="name" selected="{{ page }}" scrollable no-slide no-bar noink>
                <paper-tab name="dokumen">Data SKP</paper-tab>
                <paper-tab name="cover">Cover SKP</paper-tab>
                <paper-tab name="kegiatan">Form SKP</paper-tab>
                <paper-tab name="pengukuran">Pengukuran</paper-tab>
                <paper-tab name="perilaku">Perilaku</paper-tab>
                <paper-tab name="evaluasi">Penilaian</paper-tab>
                <paper-tab name="rapor">Rapor</paper-tab>
            </paper-tabs>
        </div>

        <div class$="tabs-content [[ screen ]]">
            <kct-pages attr-for-selected="name" selected="[[ page ]]">
                <div class="page" name="dokumen">
                    <div class="section">
                        <h3 class="section-title">Periode</h3>
                        <div>
                            <kct-column columns="2">
                                <div>
                                    <kct-date-picker value="{{ record.task.skp_start_date }}" label="Tanggal Mulai *)"></kct-date-picker>
                                </div>
                                <div>
                                    <kct-date-picker value="{{ record.task.skp_end_date }}" label="Tanggal Akhir *)"></kct-date-picker>
                                </div>
                            </kct-column>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Pegawai</h3>
                        <div>
                            <template is="dom-if" if="[[ phantom ]]">
                                <combo-user 
                                    id="combo-user" 
                                    label="Nama Pegawai *)" 
                                    value="{{ record.task.skp_su_id }}" 
                                    on-change="__onComboUserChange" 
                                    required 
                                    auto-validate 
                                    error-message="Nama pegawai wajib diisi"></combo-user>
                            </template>
                            
                            <template is="dom-if" if="[[ !phantom ]]">
                                <paper-input label="Nama Pegawai" value="[[ record.task.skp_su_fullname ]]"></paper-input>
                            </template>

                            <kct-column columns="2">
                                <div>
                                    <paper-input label="No. Induk Pegawai" value="[[ record.task.skp_su_no ]]"></paper-input>
                                </div>
                                <div>
                                    <paper-input label="Pangkat/Gol. Ruang" value="[[ record.task.skp_su_sg_name ]]"></paper-input>
                                </div>
                            </kct-column>
                            <paper-input label="Jabatan" value="[[ record.task.skp_su_sj_name ]]"></paper-input>
                            <paper-input label="Unit Kerja" value="[[ record.task.skp_su_scp_name ]]"></paper-input>
                        </div>
                    </div>

                    <kct-column columns="2">
                        <div>
                            <div class="section">
                                <h3 class="section-title">Penilai</h3>
                                <div>
                                    <combo-user 
                                        id="combo-evaluator" 
                                        label="Nama Pejabat" 
                                        value="{{ record.task.skp_evaluator }}" 
                                        on-change="__onComboEvaluatorChange"></combo-user>
                                    
                                    <kct-column columns="2">
                                        <div>
                                            <paper-input value="[[ record.task.evaluator_su_no ]]" label="No. Induk Pegawai"></paper-input>
                                        </div>
                                        <div>
                                            <paper-input value="[[ record.task.evaluator_su_sg_name ]]" label="Pangkat/Gol.Ruang"></paper-input>
                                        </div>
                                    </kct-column>
                                    <paper-input value="[[ record.task.evaluator_su_sj_name ]]" label="Jabatan"></paper-input>
                                    <paper-input value="[[ record.task.evaluator_su_scp_name ]]" label="Unit Kerja"></paper-input>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="section">
                                <h3 class="section-title">Atasan Penilai</h3>
                                <div>
                                    <combo-user 
                                        id="combo-examiner" 
                                        label="Nama Pejabat" 
                                        value="{{ record.task.skp_examiner }}" 
                                        on-change="__onComboExaminerChange"></combo-user>
                                    
                                    <kct-column columns="2">
                                        <div>
                                            <paper-input value="[[ record.task.examiner_su_no ]]" label="No. Induk Pegawai"></paper-input>
                                        </div>
                                        <div>
                                            <paper-input value="[[ record.task.examiner_su_sg_name ]]" label="Pangkat/Gol.Ruang"></paper-input>
                                        </div>
                                    </kct-column>
                                    <paper-input value="[[ record.task.examiner_su_sj_name ]]" label="Jabatan"></paper-input>
                                    <paper-input value="[[ record.task.examiner_su_scp_name ]]" label="Unit Kerja"></paper-input>
                                </div>
                            </div>
                        </div>
                    </kct-column>

                </div>
                <div class="page" name="cover">

                    <div class="cover">
                        <div class="cover-logo"></div>
                        <div class="cover-headers">
                            <paper-input placeholder="HEADER" value="{{ record.task.skp_cover_header_1 }}" no-label-float></paper-input>
                            <paper-input placeholder="HEADER" value="{{ record.task.skp_cover_header_2 }}" no-label-float></paper-input>
                        </div>
                        <div class="cover-subheaders">
                            <div>Jangka Waktu Penilaian</div>
                            <div>[[ record.task.skp_period ]]</div>
                        </div>

                        <div class="cover-body">
                            <table>
                                <tbody>
                                    <tr><td style="width: 200px;">Nama Pegawai</td><td>:</td><td><strong>[[ record.task.skp_su_fullname ]]</strong></td></tr>
                                    <tr><td>NIP</td><td>:</td><td>[[ record.task.skp_su_no ]]</td></tr>
                                    <tr><td>Pangkat Golongan Ruang</td><td>:</td><td>[[ record.task.skp_su_sg_name ]]</td></tr>
                                    <tr><td>Jabatan</td><td>:</td><td>[[ record.task.skp_su_sj_name ]]</td></tr>
                                    <tr><td>Unit Kerja</td><td>:</td><td>[[ record.task.skp_su_scp_parent ]]</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="cover-footers">
                            <paper-input placeholder="FOOTER" value="{{ record.task.skp_cover_footer_1 }}" no-label-float></paper-input>
                            <paper-input placeholder="FOOTER" value="{{ record.task.skp_cover_footer_2 }}" no-label-float></paper-input>
                        </div>

                    </div>
                </div>
                <div class="page" name="kegiatan">
                    <div class="form-section" hidden$="[[ !record.perms.update ]]">
                        <h3>Form Kegiatan</h3>
                        <div>
                            <paper-input id="input-description" value="{{ inputRecord.ski_desc }}" label="Uraian tugas (kegiatan)" always-float-label></paper-input>    
                        </div>
                        <kct-column columns="4">
                            <div>
                                <kct-input-number mask="[[ formats.VOLUME ]]" label="Kuantitas" value="{{ inputRecord.ski_volume }}"  always-float-label></kct-input-number>
                            </div>
                            <div>
                                <combo-unit value="{{ inputRecord.ski_unit }}" label="Satuan Kuantitas"  always-float-label></combo-unit>
                            </div>
                            <div>
                                <kct-input-number mask="[[ formats.QUALITY ]]" label="Kualitas" value="{{ inputRecord.ski_quality }}"  always-float-label></kct-input-number>
                            </div>
                            <div>
                                <kct-input-number mask="[[ formats.FACTOR ]]" label="Faktor Angka Kredit" value="{{ inputRecord.ski_ak_factor }}"  always-float-label></kct-input-number>
                            </div>
                        </kct-column>
                        <kct-column columns="4">
                            <div>
                                <kct-input-number mask="[[ formats.DURATION ]]" label="Waktu" value="{{ inputRecord.ski_duration }}"  always-float-label></kct-input-number>
                            </div>
                            <div>
                                <paper-input label="Satuan Waktu" value="{{ inputRecord.ski_duration_unit }}"  always-float-label></paper-input>
                            </div>
                            <div>
                                <kct-input-number mask="[[ formats.COST ]]" value="{{ inputRecord.ski_cost }}" label="Biaya"  always-float-label></kct-input-number>
                            </div>
                            <div></div>
                        </kct-column>
                        <div class="m-t">
                            <kct-checkbox value="{{ inputRecord.ski_extra }}">Tandai sebagai tugas tambahan</kct-checkbox>
                        </div>
                        <div class="m-t">
                            <paper-button disabled$="[[ __computeInvaliditem(inputRecord.ski_desc) ]]" on-tap="__onAddItemTap" class="btn-blue">Tambahkan</paper-button>&nbsp;&nbsp;
                            atau tambahkan dari <a href="javascript:;" on-click="__onLookupTap">kegiatan harian</a> yang pernah dilakukan.
                        </div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th rowspan="2" style="width: 30px;">NO</th>
                                <th rowspan="2" style="width: 30px;" hidden$="[[ !record.perms.update ]]"></th>
                                <th rowspan="2" style="min-width: 300px;">KEGIATAN TUGAS JABATAN</th>
                                <th rowspan="2" style="width: 30px;"></th>
                                <th rowspan="2" style="width: 60px;">AK</th>
                                <th colspan="6" style="width: 450px;">TARGET</th>
                            </tr>
                            <tr>
                                <th colspan="2">KUANTITAS</th>
                                <th style="width: 60px;">MUTU</th>
                                <th colspan="2">WAKTU</th>
                                <th style="width: 80px;">BIAYA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template is="dom-repeat" items="{{ record.items }}">
                                <tr>
                                    <td class="text-center">[[ __computeSequence(index) ]]</td>
                                    <td  hidden$="[[ !record.perms.update ]]">
                                        <paper-icon-button icon="close" on-tap="__onRemoveItemTap"></paper-icon-button>
                                    </td>
                                    <td>
                                        <div on-input="__onItemDescTargetChange" class="task-item-text" contenteditable spellcheck="false">[[ item.ski_text ]]</div>
                                    </td>
                                    <td class="editable"><kct-input-number mask="[[ formats.FACTOR ]]" value="{{ item.ski_ak_factor }}" placeholder="..." on-change="__onItemTargetChange" no-label-float></kct-input-number></td>
                                    <td class="text-center">[[ _numberFormat(item.ski_ak, formats.AK) ]]</td>
                                    <td class="editable" style="width: 60px;"><kct-input-number mask="[[ formats.VOLUME ]]" value="{{ item.ski_volume }}" placeholder="..." on-change="__onItemTargetChange" no-label-float></kct-input-number></td>
                                    <td class="text-center" style="width: 80px;">[[ item.ski_unit ]]</td>
                                    <td class="editable"><kct-input-number mask="[[ formats.QUALITY ]]" value="{{ item.ski_quality }}" placeholder="..." on-change="__onItemTargetChange" no-label-float></kct-input-number></td>
                                    <td class="editable" style="width: 60px;"><kct-input-number mask="[[ formats.DURATION ]]" value="{{ item.ski_duration }}" placeholder="..." on-change="__onItemTargetChange" no-label-float></kct-input-number></td>
                                    <td class="text-center" style="width: 60px;">[[ item.ski_duration_unit ]]</td>
                                    <td class="editable"><kct-input-number mask="[[ formats.COST ]]" value="{{ item.ski_cost }}" placeholder="..." on-change="__onItemTargetChange" no-label-float></kct-input-number></td>
                                </tr>
                            </template>
                            <tr class="header">
                                <td>NO</td>
                                <td colspan="2">TUGAS TAMBAHAN</td>
                                <td colspan="8"></td>
                            </tr>
                            <template is="dom-repeat" items="{{ record.extra }}">
                                <tr>
                                    <td class="text-center">[[ __computeSequence(index) ]]</td>
                                    <td>
                                        <paper-icon-button icon="close" on-tap="__onRemoveItemTap"></paper-icon-button>
                                    </td>
                                    <td>
                                        <div on-input="__onItemDescTargetChange" class="task-item-text" contenteditable spellcheck="false">[[ item.ski_text ]]</div>
                                    </td>
                                    <td colspan="8"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div class="page" name="pengukuran">
                    <table class="table table-measurement">
                        <thead>
                            <tr>
                                <th style="width: 30px;">NO</th>
                                <th style="width: 180px;">TUGAS UTAMA</th>
                                <th style="width: 20px;">&nbsp;</th>
                                <th style="width: 60px;">AK</th>
                                <th colspan="2">KUANTITAS</th>
                                <th style="width: 60px;">MUTU</th>
                                <th colspan="2">WAKTU</th>
                                <th style="width: 80px;">BIAYA</th>
                                <th style="width: 60px;">PENGHI TUNGAN</th>
                                <th style="width: 60px;">NILAI CAPAIAN</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template is="dom-repeat" items="{{ record.items }}">
                                <tr>
                                    <td rowspan="2" class="text-center">[[ __computeSequence(index) ]]</td>
                                    <td rowspan="2"><span class="text-link" on-click="__onDetailItemTap">[[ item.ski_desc ]]</span></td>
                                    <td class="text-center readonly">T</td>
                                    <td class="text-center readonly">[[ _numberFormat(item.ski_ak, formats.AK) ]]</td>
                                    <td class="text-center readonly" style="width: 60px;">[[ _numberFormat(item.ski_volume, formats.VOLUME) ]]</td>
                                    <td class="text-center readonly" style="width: 60px;">[[ item.ski_unit ]]</td>
                                    <td class="text-center readonly">[[ _numberFormat(item.ski_quality, formats.QUALITY) ]]</td>
                                    <td class="text-center readonly" style="width: 60px">[[ _numberFormat(item.ski_duration, formats.DURATION) ]]</td>
                                    <td class="text-center readonly" style="width: 60px">[[ item.ski_duration_unit ]]</td>
                                    <td class="text-center readonly">[[ _numberFormat(item.ski_cost, formats.COST) ]]</td>
                                    <td class="text-center" rowspan="2">[[ _numberFormat(item.ski_total, formats.TOTAL) ]]</td>
                                    <td class="text-center" rowspan="2">[[ _numberFormat(item.ski_performance, formats.PERFORMANCE) ]]</td>
                                </tr>
                                <tr>
                                    <td class="text-center">R</td>
                                    <td class="text-center">[[ _numberFormat(item.ski_ak_real, formats.AK) ]]</td>
                                    <td class="editable"><kct-input-number mask="[[ formats.VOLUME ]]" value="{{ item.ski_volume_real }}" placeholder="..." on-change="__onItemRealChange" no-label-float></kct-input-number></td>
                                    <td class="text-center">[[ item.ski_unit ]]</td>
                                    <td class="editable"><kct-input-number mask="[[ formats.QUALITY ]]" value="{{ item.ski_quality_real }}" placeholder="..." on-change="__onItemRealChange" no-label-float></kct-input-number></td>
                                    <td class="editable"><kct-input-number mask="[[ formats.DURATION ]]" value="{{ item.ski_duration_real }}" placeholder="..." on-change="__onItemRealChange" no-label-float></kct-input-number></td>
                                    <td class="text-center">[[ item.ski_duration_unit ]]</td>
                                    <td class="editable"><kct-input-number mask="[[ formats.COST ]]" value="{{ item.ski_cost_real }}" placeholder="..." on-change="__onItemRealChange" no-label-float></kct-input-number></td>
                                </tr>
                            </template>
                            <tr class="header">
                                <td class="text-center">NO</td>
                                <td>TUGAS TAMBAHAN</td>
                                <td colspan="10"></td>
                            </tr>
                            <template is="dom-repeat" items="[[ record.extra ]]">
                                <tr>
                                    <td class="text-center">[[ __computeSequence(index) ]]</td>
                                    <td>[[ item.ski_desc ]]</td>
                                    <td colspan="8"></td>
                                    <td class="editable"><kct-input-number mask="[[ formats.TOTAL ]]" value="{{ item.ski_total }}" placeholder="..." on-change="__onItemExtraChange" no-label-float></kct-input-number></td>
                                    <td class="editable"><kct-input-number mask="[[ formats.PERFORMANCE ]]" value="{{ item.ski_performance }}" placeholder="..." on-change="__onItemExtraChange" no-label-float></kct-input-number></td>
                                </tr>
                            </template>
                            <tr class="group">
                                <td rowspan="2" colspan="11"><strong>NILAI CAPAIAN SKP</strong></td>
                                <td class="text-center">&nbsp;[[ _numberFormat(record.task.skp_performance, formats.PERFORMANCE) ]]&nbsp;</td>
                            </tr>
                            <tr>
                                <td class="text-center">&nbsp;[[ record.task.skp_performance_criteria_text ]]&nbsp;</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="page" name="perilaku">
                    <table class="table table-behavior">
                        <thead>
                            <tr>
                                <th style="width: 500px;">PARAMETER</th>
                                <th style="width: 100px;">NILAI</th>
                                <th style="width: 100px;">KRITERIA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template is="dom-repeat" items="{{ behaviors }}">
                                <tr>
                                    <td>[[ item.tsb_tbh_name ]]</td>
                                    <td class="editable"><kct-input-number mask="[[ formats.BEHAVIOR ]]" value="{{ item.tsb_value }}" placeholder="..." on-change="__onItemBehaviorChange" no-label-float></kct-input-number></td>
                                    <td class="text-center">[[ item.tsb_criteria_text ]]</td>
                                </tr>
                            </template>
                            <tr class="group">
                                <td><strong>JUMLAH</strong></td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_behavior_total, formats.BEHAVIOR) ]]</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td><strong>RATA-RATA</strong></td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_behavior_average, formats.BEHAVIOR) ]]</td>
                                <td class="text-center">[[ record.task.skp_behavior_criteria_text ]]</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="page" name="evaluasi">
                    <table class="table table-report">
                        <thead>
                            <tr>
                                <th colspan="4" style="width: 600px;">UNSUR YANG DINILAI</th>
                                <th style="width: 100px;">JUMLAH</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2"><strong>A. Sasaran Kerja Pegawai (SKP)</strong></td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_performance, formats.PERFORMANCE) ]]</td>
                                <td class=" text-center">X [[ record.task.skp_performance_portion ]] %</td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_performance_value, formats.PERFORMANCE) ]]</td>
                            </tr>
                            <tr class="group">
                                <td style="width: 200px;"><strong>B. Perilaku Kerja</strong></td>
                                <td style="width: 200px;"></td>
                                <td style="width: 100px;"></td>
                                <td style="width: 100px;"></td>
                                <td style="width: 100px;"></td>
                            </tr>
                            <template is="dom-repeat" items="[[ behaviors ]]">
                                <tr>
                                    <td></td>
                                    <td style="width: 180px;" >[[ __computeSequence(index) ]]. [[ item.tsb_tbh_name ]]</td>
                                    <td class="text-center">[[ _numberFormat(item.tsb_value, formats.BEHAVIOR) ]]</td>
                                    <td class=" text-center" >[[ item.tsb_criteria_text ]]</td>
                                    <td class="" ></td>
                                </tr>
                            </template>
                            <tr class="group">
                                <td></td>
                                <td class="" >Jumlah</td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_behavior_total, formats.BEHAVIOR) ]]</td>
                                <td class="" ></td>
                                <td class="" ></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>Rata-rata</td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_behavior_average, formats.BEHAVIOR) ]]</td>
                                <td class=" text-center" >[[ record.task.skp_behavior_criteria_text ]]</td>
                                <td class="" ></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td class="" >Nilai Perilaku Kerja</td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_behavior_average, formats.BEHAVIOR) ]]</td>
                                <td class=" text-center" >X [[ record.task.skp_behavior_portion ]] %</td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_behavior_value, formats.BEHAVIOR) ]]</td>
                            </tr>
                            <tr class="group">
                                <td colspan="4" rowspan="2"><strong>C. Nilai Prestasi Kerja</strong></td>
                                <td class="text-center">[[ _numberFormat(record.task.skp_value, formats.PERFORMANCE) ]]</td>
                            </tr>
                            <tr>
                                <td class=" text-center" >&nbsp;[[ record.task.skp_criteria_text ]]&nbsp;</td>
                            </tr>
                        </tbody>
                    </table>

                </div>

                <div class="page" name="rapor">
                    <kct-column columns="2">
                        <div>
                            <div class="section">
                                <h3 class="section-title">Keberatan (Pegawai)</h3>
                                <div>
                                    <kct-date-picker value="{{ record.task.skp_objection_dt }}" label="Tanggal"></kct-date-picker>
                                    <paper-textarea value="{{ record.task.skp_objection }}" label="Isi Keberatan"></paper-textarea>
                                </div>
                            </div>
                            <div class="section">
                                <h3 class="section-title">Tanggapan Keberatan (Penilai)</h3>
                                <div>
                                    <kct-date-picker value="{{ record.task.skp_response_dt }}" label="Tanggal"></kct-date-picker>
                                    <paper-textarea value="{{ record.task.skp_response }}" label="Isi Tanggapan"></paper-textarea>
                                </div>
                            </div>
                            <div class="section">
                                <h3 class="section-title">Putusan Keberatan (Atasan Penilai)</h3>
                                <div>
                                    <kct-date-picker value="{{ record.task.skp_resolution_dt }}" label="Tanggal"></kct-date-picker>
                                    <paper-textarea value="{{ record.task.skp_resolution }}" label="Isi Tanggapan"></paper-textarea>
                                </div>
                            </div>
                            <div class="section">
                                <h3 class="section-title">Rekomendasi</h3>
                                <div>
                                    <paper-textarea value="{{ record.task.skp_recommendation }}" label="Isi Rekomendasi"></paper-textarea>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="section">
                                <h3 class="section-title">Pelaporan</h3>
                                <div>
                                    <paper-input value="{{ record.task.skp_report_addr }}" label="Tempat Pembuatan"></paper-input>
                                    <kct-date-picker value="{{ record.task.skp_report_dt }}" label="Tanggal Pembuatan"></kct-date-picker>
                                    <kct-date-picker value="{{ record.task.skp_receive_dt }}" label="Tanggal Diterima Pegawai"></kct-date-picker>
                                    <kct-date-picker value="{{ record.task.skp_disposition_dt }}" label="Tanggal Diterima Atasan Penilai"></kct-date-picker>
                                </div>
                            </div>
                        </div>
                    </kct-column>
                    
                    
                    
                </div>

            </kct-pages>
        </div>

        <kct-dialog id="detail-dialog" title="Detail Pengukuran" width="400" height="100%" scrollable>
            <template preserve-content>
                <style include="theme-helper"></style>
                <div slot="dialog-body">
                    <paper-input label="Faktor kuantitas" value="[[ detailRecord.calculation.volume_counter ]]"></paper-input>
                    <paper-input label="Persen waktu" value="[[ detailRecord.calculation.duration_percentage ]]"></paper-input>
                    <paper-input label="Persen biaya" value="[[ detailRecord.calculation.cost_percentage ]]"></paper-input>
                    <paper-input label="Kuantitas" value="[[ detailRecord.calculation.volume_total ]]"></paper-input>
                    <paper-input label="Kualitas" value="[[ detailRecord.calculation.quality_total ]]"></paper-input>
                    <paper-input label="Waktu" value="[[ detailRecord.calculation.duration_total ]]"></paper-input>
                    <paper-input label="Wiaya" value="[[ detailRecord.calculation.cost_total ]]"></paper-input>
                    <paper-input label$="Realisasi waktu &lt; [[ detailRecord.calculation.duration_tolerance ]]" value="[[ detailRecord.calculation.duration_lower ]]"></paper-input>
                    <paper-input label$="Realisasi waktu &gt; [[ detailRecord.calculation.duration_tolerance ]]" value="[[ detailRecord.calculation.duration_upper ]]"></paper-input>
                    <paper-input label$="Realisasi biaya &lt; [[ detailRecord.calculation.cost_tolerance ]]" value="[[ detailRecord.calculation.cost_lower ]]"></paper-input>
                    <paper-input label$="Realisasi biaya &gt; [[ detailRecord.calculation.cost_tolerance ]]" value="[[ detailRecord.calculation.cost_upper ]]"></paper-input>
                    <paper-input label="Total nilai" value="[[ detailRecord.ski_total ]]"></paper-input>
                    <paper-input label="Nilai capaian (performansi)" value="[[ detailRecord.ski_performance ]]"></paper-input>
                </div>
                <div slot="dialog-footer">
                    <paper-button on-tap="__onDetailCloseTap">Tutup</paper-button>
                </div>
            </template>
        </kct-dialog>

        <kct-dialog id="exam-dialog" title="Pemeriksaan" width="400" height="100%" scrollable>
            <template preserve-content>
                <style include="theme-helper"></style>

                <div slot="dialog-body">
                    <kct-date-picker value="{{ examRecord.ske_date }}" label="Tanggal Pemeriksaan"></kct-date-picker>
                    <kct-combobox 
                        url="/skp/skp-flags" 
                        label="Tindakan" 
                        value="{{ examRecord.ske_flag }}" 
                        item-label-path="text" 
                        item-value-path="name"></kct-combobox>
                    <paper-input value="{{ examRecord.ske_notes }}" label="Catatan Pemeriksaan"></paper-input>
                </div>
                <div slot="dialog-footer">
                    <paper-button on-tap="__onExamDialogSave">OK</paper-button>
                    <paper-button on-tap="__onExamDialogCancel">BATAL</paper-button>
                </div>
            </template>
        </kct-dialog>

    </template>
    <script>
        class FormSkp extends Mixins(FormBase).use(Mixins.SkpBehavior, Mixins.Formatter) {
            static get is() {
                return 'form-skp';
            }

            static get properties() {
                return {
                    page: { type: String, value: 'dokumen' }
                }
            }

            setup() {

                this.__registerComponent('combo-evaluator');
                this.__registerComponent('combo-examiner');
                
                if (this.action == 'create') {

                    this.__registerComponent('combo-user');

                    // resolve dependencies
                    return Promise.all([
                        this.__loadBehaviors()
                    ]);
                } else {
                    return Promise.all([
                        this.__loadCriteria()
                    ]);
                }
            }

            initialize() {

                if (this.action == 'create') {
                    let today = moment();
                    let startDate = today.clone().startOf('year');
                    let endDate = today.clone().endOf('year');

                    this.set('record.task.skp_start_date', startDate.format('YYYY-MM-DD'));
                    this.set('record.task.skp_end_date', endDate.format('YYYY-MM-DD'));

                    this.set('record.task.skp_su_id', this.user.su_id);
                    this.set('record.task.skp_su_fullname', this.user.su_fullname);
                    this.set('record.task.skp_su_no', this.user.su_no);
                    this.set('record.task.skp_su_sg_name', this.user.su_sg_name);
                    this.set('record.task.skp_su_sj_name', this.user.su_sj_name);
                    this.set('record.task.skp_su_scp_name', this.user.su_scp_name);

                    this.set('record.task.skp_cover_header_1', 'PENILAIAN PRESTASI KERJA');
                    this.set('record.task.skp_cover_header_2', 'PEGAWAI NEGERI SIPIL');
                    this.set('record.task.skp_cover_footer_1', (this.user.su_scp_name || '').toUpperCase());
                    this.set('record.task.skp_cover_footer_2', 'TAHUN ' + today.format('YYYY'));

                    this.set('record.perms.update_labels', true);
                    this.set('record.perms.update_users', true);

                    this.set('buttons', 'save');

                    this.set('page', 'dokumen');
                    this.$.tabs.notifyResize();
                } else {
                    let buttons = [];
                    let page = 'kegiatan';

                    switch(this.record.task.skp_task_flag) {
                        case 'TODO':
                        case 'REVISION':
                            this.set('record.perms.update', this.record.task.skp_su_id == this.user.su_id);
                            this.set('record.perms.update_users', true);
                            this.set('record.perms.update_labels', true);
                            this.set('record.perms.remove', this.record.perms.update);
                            this.set('record.perms.exam', [this.record.task.skp_evaluator, this.record.task.skp_examiner].indexOf(this.user.su_id) !== -1);
                            buttons = ['save', 'send', 'print'];

                            break;
                        case 'EXAM':
                            this.set('record.perms.update', this.record.task.skp_su_id == this.user.su_id);
                            this.set('record.perms.update_users', true);
                            this.set('record.perms.update_labels', true);
                            this.set('record.perms.remove', this.record.perms.update);
                            this.set('record.perms.exam', [this.record.task.skp_evaluator, this.record.task.skp_examiner].indexOf(this.user.su_id) !== -1);

                            if (this.record.perms.exam) {
                                buttons = ['save', 'send', 'print'];
                            } else {
                                buttons = ['save', 'print'];
                            }

                            page = 'perilaku';

                            break;
                        case 'DONE':
                            this.set('record.perms.update', false);
                            this.set('record.perms.update_users', false);
                            this.set('record.perms.update_labels', false);
                            this.set('record.perms.remove', false);
                            this.set('record.perms.exam', false);

                            buttons = ['print'];

                            page = 'evaluasi';

                            break;
                    }

                    if (this.record.perms.remove) {
                        buttons.push('remove');
                    }

                    this.set('buttons', buttons.join(','));

                    this.__loadItems();
                    this.__loadBehaviors();

                    this.set('page', page);
                    this.$.tabs.notifyResize();
                }

                this.__doLayout();
            }

            beforeSave(options) {
                let promise = this.resolve({ success: true });

                if (this.action == 'create') {
                    this.set('record.task.skp_task_flag', 'TODO');
                } else {
                    if (options.send) {
                        let flag = this.record.task.skp_task_flag;

                        if (flag == 'TODO' || flag == 'REVISION') {
                            this.set('record.task.skp_task_flag', 'EXAM');
                        } else if (flag == 'EXAM') {
                            promise = this.__examine().then(exam => {
                                console.log(exam);
                                return { success: exam };
                            });
                        }
                    }
                }
                return promise;
            }

            __doLayout() {
                // hide all table first
                let tables = this.shadowRoot.querySelectorAll('.table-responsive');
                
                tables.forEach(t => {
                    t.style.display = 'none';
                });

                let timer = setTimeout(() => {
                    //let width = this.clientWidth - 60;
                    let width = 500;

                    tables.forEach(t => {
                        t.style.width = width + 'px';
                        t.style.display = 'block';
                    });

                    clearTimeout(timer);
                    timer = null;
                }, 100);
            }

            __examine() {
                this.__examResolver = this.defer();
                this.__initExamRecord();
                this.$['exam-dialog'].open();
                return this.__examResolver.promise;
            }

            __onAddItemTap() {
                let payload = Object.assign({}, this.inputRecord);
                this.__addItem(payload);

                // cleanup and focus
                let timer = setTimeout(() => {
                    clearTimeout(timer);
                    timer = null;

                    this.set('inputRecord', {});
                    this.$['input-description'].focus();
                }, 1);
            }

            __onRemoveItemTap(e) {
                this.confirm('Konfirmasi', 'Anda yakin akan menghapus item tersebut?').then(y => {
                    if (y) {
                        this.$.ajax.DELETE('/skp/skp-items/' + e.model.item.ski_id).then(res => {
                            if (res.success) {
                                if (e.model.item.ski_extra == 0) {
                                    this.splice('record.items', e.model.index, 1);    
                                } else {
                                    this.splice('record.extra', e.model.index, 1);    
                                }

                                this.__computeSummary();
                                this.__saveSummary();
                            }
                        });
                    }
                });
            }

            __onLookupTap(e) {
                if ( ! this.$['lookup-items']) {
                    Polymer.importHref(this.resolveUrl('../plugins/lookup-items.html'), () => {
                        let lov = document.createElement('lookup-items');

                        lov.addEventListener('beforeload', e => {
                            let options = e.detail.options;
                            options.lookup = 'skp';

                            let params = {};

                            if (this.record.task.skp_su_id) {
                                params.lkh_su_id = this.record.task.skp_su_id;
                            }

                            if (this.record.task.skp_start_date && this.record.task.skp_end_date) {
                                params.lkh_start_date = this.record.task.skp_start_date;
                                params.lkh_end_date = this.record.task.skp_end_date;
                            }

                            options.params = params;
                        });

                        lov.addEventListener('close', () => {
                            let items = [];

                            lov.selection.forEach(item => {
                                let data = {
                                    ski_skp_id: this.record.task.skp_id,
                                    ski_desc: item.lki_desc,
                                    ski_volume: null,
                                    ski_volume_real: null,
                                    ski_unit: item.lki_unit,
                                    ski_quality: null,
                                    ski_quality_real: null,
                                    ski_cost: item.lki_cost,
                                    ski_cost_real: item.lki_cost,
                                    ski_duration: null,
                                    ski_duration_real: null,
                                    ski_duration_unit: item.lki_duration_unit,
                                    ski_ak: null,
                                    ski_ak_real: null,
                                    ski_ak_factor: null,
                                    ski_extra: 0,
                                    ski_total: null,
                                    ski_performance: null
                                };

                                items.push(data);

                            });

                            if (items.length) {
                                this.$.ajax.POST('/skp/skp-items/save-batch', { items: items }).then(res => {
                                    if (res.success) {
                                        let items = (this.record.items || []).slice();
                                        Array.prototype.push.apply(items, res.data || []);
                                        this.set('record.items', items);

                                        let timer = setTimeout(() => {
                                            clearTimeout(timer);
                                            timer = null;

                                            this.__computeSummary();
                                            this.__saveSummary();

                                        }, 10);
                                    }   
                                });
                            }

                        });

                        this.shadowRoot.appendChild(lov);
                        lov.open();
                        this.$['lookup-items'] = lov;
                    });    
                } else {
                    this.$['lookup-items'].open();
                }
                
            }

            __onDetailItemTap(e) {
                this.set('detailRecord', Object.assign({}, e.model.item));
                this.$['detail-dialog'].open();
            }

            __onDetailCloseTap() {
                this.$['detail-dialog'].close();
            }

            __onComboUserChange(e) {
                let user = e.target.getModelForValue(e.target.value);

                if (user) {
                    this.set('record.task.skp_su_no', user.su_no);
                    this.set('record.task.skp_su_sg_name', user.su_sg_name);
                    this.set('record.task.skp_su_sdp_name', user.su_sdp_name);
                    this.set('record.task.skp_su_sj_name', user.su_sj_name);
                } else {
                    this.set('record.task.skp_su_no', '');
                    this.set('record.task.skp_su_sg_name', '');
                    this.set('record.task.skp_su_sdp_name', '');
                    this.set('record.task.skp_su_sj_name', '');
                }
            }

            __onComboEvaluatorChange(e) {
                let user = e.target.getModelForValue(e.target.value);
                
                if (user) {
                    this.set('record.task.evaluator_su_no', user.su_no);
                    this.set('record.task.evaluator_su_sg_name', user.su_sg_name);
                    this.set('record.task.evaluator_su_sdp_name', user.su_sdp_name);
                    this.set('record.task.evaluator_su_sj_name', user.su_sj_name);

                    this.__addAssignee(user);

                } else {
                    this.set('record.task.evaluator_su_no', '');
                    this.set('record.task.evaluator_su_sg_name', '');
                    this.set('record.task.evaluator_su_sdp_name', '');
                    this.set('record.task.evaluator_su_sj_name', '');
                }
            }

            __onComboExaminerChange(e) {
                let user = e.target.getModelForValue(e.target.value);

                if (user) {
                    this.set('record.task.examiner_su_no', user.su_no);
                    this.set('record.task.examiner_su_sg_name', user.su_sg_name);
                    this.set('record.task.examiner_su_sdp_name', user.su_sdp_name);
                    this.set('record.task.examiner_su_sj_name', user.su_sj_name);

                    this.__addAssignee(user);

                } else {
                    this.set('record.task.examiner_su_no', '');
                    this.set('record.task.examiner_su_sg_name', '');
                    this.set('record.task.examiner_su_sdp_name', '');
                    this.set('record.task.examiner_su_sj_name', '');
                }
            }     

            __onItemBehaviorChange(e) {
                let updatable = this.record.perms.update || this.record.perms.exam;

                if ( ! updatable) {
                    return;
                }

                this.__computeBehavior(e.model.item, e.model.index);
                this.__computeSummary();

                this.__saveBehaviors(e.model.item);
                this.__saveSummary();
            }

            __onItemDescTargetChange(e) {
                if ( ! this.record.perms.update) {
                    return;
                }

                let text = e.target.textContent;

                if (e.model.item.ski_extra == 0) {
                    this.set('record.items.' + e.model.index + '.ski_desc', text);    
                } else {
                    this.set('record.extra.' + e.model.index + '.ski_desc', text);    
                }
                
                this.__saveItem(e.model.item, e.model.index);
            }

            __onItemTargetChange(e) {
                if ( ! this.record.perms.update) {
                    return;
                }

                this.__computeItem(e.model.item, e.model.index);
                this.__computeSummary();

                this.__saveItem(e.model.item, e.model.index);
                this.__saveSummary();    
            }

            __onItemRealChange(e) {
                let updatable = this.record.perms.update || this.record.perms.exam;
                if ( ! updatable) {
                    return;
                }

                this.__computeItem(e.model.item, e.model.index);
                this.__computeSummary();

                this.__saveItem(e.model.item, e.model.index);
                this.__saveSummary();
            }

            __onItemExtraChange(e) {
                let updatable = this.record.perms.update || this.record.perms.exam;
                if ( ! updatable) {
                    return;
                }

                this.__computeSummary();

                this.__saveItem(e.model.item, e.model.index);
                this.__saveSummary();
            }

            __onExamDialogSave() {
                this.$['exam-dialog'].close();

                let payload = Object.assign({}, this.examRecord);

                if (payload.ske_id) {
                    this.$.ajax.PUT('/skp/skp-exams/' + payload.ske_id, payload).then(done.bind(this));
                } else {
                    this.$.ajax.POST('/skp/skp-exams', payload).then(done.bind(this));
                }

                function done(res) {
                    if (res.success) {
                        this.set('record.task.skp_task_flag', res.data.ske_flag);
                        this.__examResolver.resolve(true);
                    }
                }
            }

            __onExamDialogCancel() {
                this.$['exam-dialog'].close();
                this.__examResolver.resolve(false);
            }

            __onSocketNotify(e) {
                let payload = e.detail;
                let project = this.project && this.project.sp_id;
                let task = this.record && this.record.task && this.record.task.skp_id;

                if (project == payload.project && task == payload.task) {
                    let data, path, items, index;

                    data = JSON.parse(payload.data || '{}');

                    switch(payload.type) {
                        case 'create_skp_item':

                            if (data.ski_id) {
                                items = data.ski_extra == 1 ? (this.record.extra || []) : (this.record.items || []);
                                index = items.findIndex(elem => elem.ski_id == data.ski_id);

                                if (index === -1) {
                                    path = 'record.' + (data.ski_extra == 1 ? 'extra' : 'items');

                                    this.$.ajax.GET('/skp/skp-items/' + data.ski_id).then(res => {
                                        if (res.success) {
                                            this.push(path, res.data);
                                            this.__computeSummary();
                                        }
                                    });
                                }
                            }

                            break;

                        case 'update_skp_item':
                            if (data.ski_id) {
                                items = data.ski_extra == 1 ? (this.record.extra || []) : (this.record.items || []);
                                index = items.findIndex(elem => elem.ski_id == data.ski_id);

                                if (index !== -1) {
                                    path = 'record.' + (data.ski_extra == 1 ? 'extra' : 'items') + '.' + index;
                                    
                                    this.$.ajax.GET('/skp/skp-items/' + data.ski_id).then(res => {
                                        if (res.success) {
                                            this.set(path, res.data);
                                            this.__computeSummary();
                                        }
                                    });
                                }
                            }
                            break;
                        case 'remove_skp_item':
                            if (data.ski_id) {
                                items = data.ski_extra == 1 ? (this.record.extra || []) : (this.record.items || []);
                                index = items.findIndex(elem => elem.ski_id == data.ski_id);

                                if (index !== -1) {
                                    path = 'record.' + (data.ski_extra == 1 ? 'extra' : 'items');
                                    this.splice(path, index, 1);
                                    this.__computeSummary();
                                }
                            }

                            break;

                        case 'update_skp_behavior':
                            if (data.tsb_id) {
                                index = (this.behaviors || []).findIndex(elem => elem.tsb_id == data.tsb_id);
                                if (index !== -1) {
                                    this.$.ajax.GET('/skp/skp-behaviors/' + data.tsb_id).then(res => {
                                        if (res.success) {
                                            this.set('behaviors.' + index, res.data);
                                            this.__computeBehavior(res.data, index);
                                            this.__computeSummary();
                                        }
                                    });    
                                }
                                
                            }
                            break;
                    }

                    
                }
            }
        }
        customElements.define(FormSkp.is, FormSkp);
    </script>
</dom-module>