<link rel="import" href="../../../../../cores/vendors/moment/moment.html">

<dom-module id="form-skp">
    <template>
        <style include="form-style">
            .item-row {
                display: block;
                background-color: #F9F9F9;
                border: 1px solid #dfdfdf;
                box-shadow: none;
                border-radius: 0;
                position: relative;
            }
            .item-row + .item-row {
                margin-top: 15px;
            }
            .item-row vaadin-combo-box {
                padding: 2px 0;
                --paper-input-container-label-floating: {
                    margin-bottom: 0;
                };
            }
            .item-actions {
                position: absolute;
                top: 5px;
                right: 5px;
            }
        </style>

        <kct-ajax id="ajax"></kct-ajax>

        <div class="section">
            <h3 class="section-title">Pegawai</h3>
            <div>
                <kct-column columns="3">
                    <div>
                        <paper-input label="Nama Lengkap" value="{{ record.data.skp_su_fullname }}" readonly></paper-input>
                    </div>
                    <div>
                        <paper-input label="No. Induk" value="{{ record.data.skp_su_no }}" readonly></paper-input>
                    </div>
                    <div>
                        <paper-input label="Pangkat / Gol. Ruang" value="{{ record.data.skp_su_grade }}" readonly></paper-input>
                    </div>
                </kct-column>
                <paper-input label="Jabatan" value="{{ record.data.skp_su_sj_name }}" readonly></paper-input>
                <paper-input label="Unit Kerja" value="{{ record.data.skp_su_sdp_name }}" readonly></paper-input>
                <vaadin-date-picker label="Tanggal Pembuatan SKP" value="{{ record.data.skp_date }}"></vaadin-date-picker>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Kegiatan Utama</h3>
        </div>
        <div class="p-b" style="margin-top: -1px">
            <template is="dom-repeat" items="[[ record.data.primary_items ]]">
                        
                <paper-card class="item-row">
                    <div class="card-content">
                        <div class="item-actions">
                            <paper-icon-button on-tap="__onRemovePrimaryItemTap" icon="close"></paper-icon-button>
                        </div>
                        <paper-input value="{{ item.lki_desc }}"  label="Uraian Kegiatan"></paper-input>
                        <kct-column columns="3">
                            <div>
                                <paper-input value="{{ item.lki_volume }}"  label="Volume" ></paper-input>
                            </div>
                            <div>
                                <vaadin-combo-box 
                                    items="[[ units ]]" 
                                    label="Satuan"
                                    value="{{ item.lki_unit }}" 
                                    item-value-path="sun_name" 
                                    item-label-path="sun_name" 
                                    ></vaadin-combo-box>
                            </div>
                            <div>
                                <paper-input value="{{ item.lki_cost }}"  label="Biaya" ></paper-input>
                            </div>
                        </kct-column>
                    </div>
                </paper-card>
            </template>
            <div class="m-t-sm text-right">
                <paper-button on-tap="__onAddPrimaryItemTap" class="btn-blue-grey m-r-0"><iron-icon icon="add"></iron-icon>&nbsp;Tambah Kegiatan</paper-button>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Kegiatan Tambahan</h3>
        </div>
        <div class="p-b" style="margin-top: -1px">
            <template is="dom-repeat" items="[[ record.data.subsidiary_items ]]">
                        
                <paper-card class="item-row">
                    <div class="card-content">
                        <div class="item-actions">
                            <paper-icon-button on-tap="__onRemoveSubsidiaryItemTap" icon="close"></paper-icon-button>
                        </div>
                        <paper-input value="{{ item.lki_desc }}"  label="Uraian Kegiatan"></paper-input>
                        <kct-column columns="3">
                            <div>
                                <paper-input value="{{ item.lki_volume }}"  label="Volume" ></paper-input>
                            </div>
                            <div>
                                <vaadin-combo-box 
                                    items="[[ units ]]" 
                                    label="Satuan"
                                    value="{{ item.lki_unit }}" 
                                    item-value-path="sun_name" 
                                    item-label-path="sun_name" 
                                    ></vaadin-combo-box>
                            </div>
                            <div>
                                <paper-input value="{{ item.lki_cost }}"  label="Biaya" ></paper-input>
                            </div>
                        </kct-column>
                    </div>
                </paper-card>
            </template>
            <div class="m-t-sm text-right">
                <paper-button on-tap="__onAddSubsidiaryItemTap" class="btn-blue-grey m-r-0"><iron-icon icon="add"></iron-icon>&nbsp;Tambah Kegiatan</paper-button>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Pemeriksaan</h3>
            <div>
                <kct-combobox 
                    id="combo-module" 
                    url="/skp/exam/modules" 
                    label="Module Pemeriksaan" 
                    value="{{ record.data.skp_exam_id }}" 
                    page-size="10" 
                    item-label-path="sp_title" 
                    item-value-path="sp_id"></kct-combobox>
            </div>
        </div>

    </template>
    <script>
        class FormSkp extends FormBase {
            static get is() {
                return 'form-skp';
            }

            static get observers() {
                return [
                    '__computeTask(record.data.skp_su_fullname, record.data.skp_date)'
                ];
            }

            initialize() {
                
                this.$['combo-module'].load();

                if (this.action == 'create') {
                    let today = moment();

                    this.set('record.data.skp_su_id', this.user.su_id);
                    this.set('record.data.skp_su_fullname', this.user.su_fullname);
                    this.set('record.data.skp_su_no', this.user.su_no);
                    this.set('record.data.skp_su_grade', this.user.su_grade);
                    this.set('record.data.skp_su_sj_name', this.user.su_sj_name);
                    this.set('record.data.skp_su_sdp_name', this.user.su_sdp_name);
                    this.set('record.data.skp_date', today.format('YYYY-MM-DD'));
                    this.set('record.data.primary_items', [{}]);
                    this.set('record.data.subsidiary_items', [{}]);

                    return this.resolve();
                } else {
                    if (this.record.status.tts_data_id) {
                        return this.$.ajax.GET('/skp/' + this.record.status.tts_data_id).then(res => {
                            this.set('record.data', res.data);
                        });
                    } else {
                        return this.resolve();
                    }
                }
            }

            save(options) {
                let payload = this.record.data;

                if (options.send) {

                    // validate exam target
                    if ( ! payload.skp_exam_id) {
                        this.toast('Warning', 'Anda belum memilih module pemeriksaan', 'warn');
                        return this.resolve({ success: false });
                    }

                }

                if (payload.skp_id) {
                    return this.$.ajax.PUT('/skp/' + payload.skp_id, payload).then(done.bind(this));
                } else {
                    return this.$.ajax.POST('/skp', payload).then(done.bind(this));
                }

                function done(res) {
                    if (res.success) {
                        this.set('record.data', res.data);
                        this.set('record.status.tts_data_id', res.data.skp_id);

                        if (options.send) {
                            return this.$.ajax.POST('/skp/exam/init', payload);
                        } else {
                            return res;
                        }

                    } else {
                        this.toast('Warning', res.message, 'warn');
                    }

                    return res;
                }
            }

            remove() {
                return this.$.ajax.DELETE('/skp/' + this.record.data.skp_id);
            }

            __computeTask(name, date) {
                let year = '';

                name = name || '';

                if ( ! date) {
                    year = moment().format('YYYY');
                } else {
                    year = moment(date).format('YYYY');
                }

                this.set('record.task.tt_title', name + ' - ' + year);
            }

            __onAddPrimaryItemTap() {
                this.push('record.data.primary_items', {});
            }

            __onAddSubsidiaryItemTap() {
                this.push('record.data.subsidiary_items', {});
            }

            __onRemovePrimaryItemTap(e) {
                this.splice('record.data.primary_items', e.model.index, 1);
            }

            __onRemoveSubsidiaryItemTap(e) {
                this.splice('record.data.subsidiary_items', e.model.index, 1);
            }
        }
        customElements.define(FormSkp.is, FormSkp);
    </script>
</dom-module>