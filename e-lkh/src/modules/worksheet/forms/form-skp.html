<dom-module id="form-skp">
    <template>
        <style include="form-style">
            :host {
                margin: -30px;
            }

            .input-task {
                margin: 0 0 5px 0;
                padding: 15px 15px 15px 15px;
                background-color: var(--paper-grey-100);
                border-radius: 3px;
                position: relative;
            }
            .input-task .input-actions {
                position: absolute;
                right: 5px;
                top: 50%;
                height: 40px;
                margin-top: -20px;
                color: #888;
            }
            .input-task paper-button {
                background-color: var(--paper-grey-300);
                font-size: 12px;
            }
            .task-item {
                padding: 15px 15px 15px 6px;
                background-color: var(--paper-grey-200);
                border-radius: 3px;
            }
            .task-item .icon {
                width: 50px; 
                cursor: pointer;
                text-align: center;
            }
            .task-item .icon paper-icon-button {
                position: relative;
                top: -8px;
            }
            .task-item + .task-item {
                margin-top: 5px;
            }
            .task-item-sequence {
                margin-bottom: 8px;
            }
            .task-item-detail paper-button {
                font-size: 12px;
            }
            .task-item-detail .btn-remove {
                background-color: var(--paper-red-400);
                color: #fff;
            }
            .task-item-editable {
                outline: none;
            }
            .task-item-sequence > span {
                font-size: 16px;
                font-weight: 500;
                text-align: center;
                display: inline-block;
                width: 30px;
                height: 30px;
                background-color: var(--paper-grey-300);
                border-radius: 50%;
                line-height: 30px;
            }
            .task-item h3 {
                font-size: 14px;
                font-weight: 500;
                margin: 0;
            }
            .task-item-detail {
                --paper-input-container: {

                };
                --paper-input-container-label: {
                    text-transform: uppercase;
                    
                };
                --paper-input-container-label-floating: {
                    font-size: 13px;
                    font-weight: 500;
                };
                --paper-input-container-underline: {
                    border-color: var(--paper-grey-400);
                };
            }
            .task-item-detail > kct-hbox > div + div {
                padding-left: 12px;
            }
            .task-item-detail > kct-hbox > .flex-half {
                width: 30px;
            }
            .task-item-detail kct-combobox {
                /*padding: 4px 0;*/
                --paper-input-container-label-floating: {
                    top: 0;
                    font-size: 13px;
                    font-weight: 500;
                    /*top: 8px;*/
                };
            }

            .task-item-detail kct-checkbox {
                --paper-checkbox-margin: 0;
            }

            .tabs {
                position: relative;
            }

            .tabs::before {
                content: ' ';
                display: block;
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 2px;
                background-color: var(--paper-grey-200);
            }

            .tabs paper-tabs {
                height: 40px;
                --paper-tabs-scroller-opacity: 0.3;
                --paper-tabs-selection-bar-color: var(--paper-red-500);
                --paper-tabs-selection-bar: {
                    border-bottom-width: 2px;
                };
            }

            .tabs paper-tab {
                min-width: 100px;
                text-transform: uppercase;
                --paper-tab-ink: var(--paper-blue-grey-500);
            }

            .tabs paper-tab.iron-selected {
                color: var(--paper-red-500);
            }

            .tabs-content .page {
                display: block;
                padding: 30px;
            }

            .tabs-content.sm .task-item-detail > kct-hbox {
                display: block;
            }

            .tabs-content.sm .task-item-detail > kct-hbox > div {
                display: block;
                padding: 0 !important;
            }

        </style>

        <kct-ajax id="ajax"></kct-ajax>
        <kct-media screen="{{ screen }}"></kct-media>

        <div class="tabs">
            <paper-tabs attr-for-selected="name" selected="{{ page }}">
                <paper-tab name="dokumen">Dokumen</paper-tab>
                <paper-tab name="kegiatan">Kegiatan</paper-tab>
                <paper-tab name="penilaian">Penilaian</paper-tab>
            </paper-tabs>
        </div>

        <div class$="tabs-content [[ screen ]]">
            <kct-pages attr-for-selected="name" selected="[[ page ]]">
                <div class="page" name="dokumen">
                    <div class="section">
                        <h3 class="section-title">Identias Pegawai</h3>
                        <div>
                            <template is="dom-if" if="[[ phantom ]]">
                                <combo-user 
                                    id="combo-user" 
                                    label="Nama Pegawai *)" 
                                    value="{{ record.task.skp_su_id }}" 
                                    on-change="__onComboUserChange" 
                                    required 
                                    auto-validate 
                                    error-message="Nama pegawai wajib diisi"></combo-user>
                            </template>
                            
                            <template is="dom-if" if="[[ !phantom ]]">
                                <paper-input label="Nama Pegawai" value="[[ record.task.skp_su_fullname ]]"></paper-input>
                            </template>

                            <kct-column columns="2">
                                <div>
                                    <paper-input label="No. Induk Pegawai" value="[[ record.task.skp_su_no ]]"></paper-input>
                                </div>
                                <div>
                                    <paper-input label="Pangkat/Gol. Ruang" value="[[ record.task.skp_su_grade ]]"></paper-input>
                                </div>
                            </kct-column>
                            <paper-input label="Jabatan" value="[[ record.task.skp_su_sj_name ]]"></paper-input>
                            <paper-input label="Unit Kerja" value="[[ record.task.skp_su_sdp_name ]]"></paper-input>
                        </div>
                    </div>

                    <div class="section">
                        <h3 class="section-title">Periode SKP</h3>
                        <div>
                            <kct-column columns="2">
                                <div>
                                    <kct-date-picker value="{{ record.task.skp_start_date }}" label="Tanggal Mulai *)"></kct-date-picker>
                                </div>
                                <div>
                                    <kct-date-picker value="{{ record.task.skp_end_date }}" label="Tanggal Akhir *)"></kct-date-picker>
                                </div>
                            </kct-column>
                        </div>
                    </div>

                    <div class="section">
                        <h3 class="section-title">Pejabat Penilai</h3>
                        <div>
                            <template is="dom-if" if="[[ phantom ]]">
                                <combo-user 
                                    id="combo-examiner" 
                                    label="Pejabat Penilai" 
                                    value="{{ record.task.skp_examiner }}" 
                                    on-change="__onComboExaminerChange"></combo-user>
                            </template>
                            
                            <template is="dom-if" if="[[ !phantom ]]">
                                <paper-input value="[[ record.task.examiner_su_fullname ]]" label="Pejabat Penilai"></paper-input>
                            </template>

                            <kct-column columns="2">
                                <div>
                                    <paper-input value="[[ record.task.examiner_su_no ]]" label="No. Induk Pegawai"></paper-input>
                                </div>
                                <div>
                                    <paper-input value="[[ record.task.examiner_su_grade ]]" label="Pangkat/Gol.Ruang"></paper-input>
                                </div>
                            </kct-column>
                            <paper-input value="[[ record.task.examiner_su_sj_name ]]" label="Jabatan"></paper-input>
                            <paper-input value="[[ record.task.examiner_su_sdp_name ]]" label="Unit Kerja"></paper-input>
                        </div>
                    </div>

                    <div class="section">
                        <h3 class="section-title">Atasan Pejabat Penilai</h3>
                        <div>
                            <combo-user 
                                id="combo-superior" 
                                label="Nama Pejabat" 
                                value="{{ record.task.skp_superior }}" 
                                on-change="__onComboSuperiorChange"></combo-user>
                            <kct-column columns="2">
                                <div>
                                    <paper-input value="[[ record.task.superior_su_no ]]" label="No. Induk Pegawai"></paper-input>
                                </div>
                                <div>
                                    <paper-input value="[[ record.task.superior_su_grade ]]" label="Pangkat/Gol.Ruang"></paper-input>
                                </div>
                            </kct-column>
                            <paper-input value="[[ record.task.superior_su_sj_name ]]" label="Jabatan"></paper-input>
                            <paper-input value="[[ record.task.superior_su_sdp_name ]]" label="Unit Kerja"></paper-input>
                        </div>
                    </div>

                </div>
                <div class="page" name="kegiatan">
                    
                    <div class="section">
                        <div class="input-task">
                            <paper-input id="input" on-keydown="__onTaskInputKeydown" placeholder="Tulis kegiatan tugas jabatan Anda di sini kemudian tekan enter..." no-label-float></paper-input>
                            <div class="m-t-sm">
                                <paper-button on-tap="__onAddTaskTap">Tambahkan ke daftar</paper-button>&nbsp;&nbsp;atau cari dari <a on-tap="__onLookupTap" href="javascript:;">kegiatan harian</a>
                            </div>
                        </div>
                        <div class="task-list">
                            <template is="dom-repeat" items="[[ record.items ]]">
                                <kct-hbox class="task-item">
                                    <div class="icon">
                                        <div class="task-item-sequence">
                                            <span>[[ item.ski_seq ]]</span>
                                        </div>
                                    </div>
                                    <div class="flex">
                                        <kct-hbox>
                                            <div class="flex">
                                                <div on-input="__onTaskItemChange" class="task-item-editable" contenteditable spellcheck="false">[[ item.ski_text ]]</div>
                                            </div>
                                            <div>
                                                <paper-icon-button hidden$="[[ item.ski_expand ]]" on-tap="__onTaskItemToggle" icon="arrow-drop-down"></paper-icon-button>
                                                <paper-icon-button hidden$="[[ !item.ski_expand ]]" on-tap="__onTaskItemToggle" icon="arrow-drop-up"></paper-icon-button>
                                            </div>
                                        </kct-hbox>
                                        
                                        <div class="task-item-detail m-t" hidden$="[[ !item.ski_expand ]]">
                                            <h3>TARGET</h3>
                                            <kct-hbox>
                                                <div class="flex">
                                                    <paper-input label="Volume" value="{{ item.ski_volume }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex">
                                                    <kct-combobox 
                                                        label="Satuan" 
                                                        items="[[ units ]]" 
                                                        value="{{ item.ski_unit }}"
                                                        item-label-path="sun_name" 
                                                        item-value-path="sun_name"  
                                                        list-width="150" 
                                                        always-float-label 
                                                        hide-arrow 
                                                        hide-clear></kct-combobox>
                                                </div>
                                                <div class="flex">
                                                    <paper-input label="Kualitas" value="{{ item.ski_quality }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex">
                                                    <kct-input-number label="Biaya" mask="#.###" value="{{ item.ski_cost }}" always-float-label></kct-input-number>
                                                </div>
                                                <div class="flex">
                                                    <paper-input label="Waktu" value="{{ item.ski_duration }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex-half">
                                                    <paper-input value="{{ item.ski_duration_unit }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex">
                                                    <paper-input label="AK" value="{{ item.ski_ak }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex-half">
                                                    <paper-input value="{{ item.ski_ak_factor }}" always-float-label></paper-input>
                                                </div>
                                            </kct-hbox>
                                            
                                        </div>
                                        <div class="task-item-detail"  hidden$="[[ !item.ski_expand ]]">
                                            <h3>REALISASI</h3>
                                            <kct-hbox>
                                                <div class="flex">
                                                    <paper-input label="Volume" value="{{ item.ski_volume_real }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex">
                                                    <paper-input label="Satuan" value="{{ item.ski_unit }}" always-float-label></paper-input>
                                                </div>
                                                
                                                <div class="flex">
                                                    <paper-input label="Kualitas" value="{{ item.ski_quality_real }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex">
                                                    <kct-input-number label="Biaya" mask="#.###" value="{{ item.ski_cost_real }}" always-float-label></kct-input-number>
                                                </div>
                                                <div class="flex">
                                                    <paper-input label="Waktu" value="{{ item.ski_duration }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex-half">
                                                    <paper-input value="{{ item.ski_duration_unit }}" always-float-label></paper-input>
                                                </div>  
                                                <div class="flex">
                                                    <paper-input label="AK" value="{{ item.ski_ak_real }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex-half">
                                                    <paper-input value="{{ item.ski_ak_factor }}" always-float-label></paper-input>
                                                </div>
                                            </kct-hbox>
                                            
                                        </div>
                                        <div class="task-item-detail"  hidden$="[[ !item.ski_expand ]]">
                                            <h3>PENILAIAN</h3>
                                            <kct-hbox>
                                                <div class="flex">
                                                    <paper-input label="Penghitungan" value="{{ item.ski_total }}" always-float-label></paper-input>
                                                </div>
                                                <div class="flex">
                                                    <paper-input label="Nilai Capaian" value="{{ item.ski_performance }}" always-float-label></paper-input>
                                                </div>
                                            </kct-hbox>
                                            <kct-hbox class="m-t-sm">
                                                <div class="flex">
                                                    <kct-checkbox value="{{ item.ski_extra }}">Tandai sebagai tugas tambahan</kct-checkbox>
                                                </div>
                                                <div class="text-right">
                                                    <paper-button on-tap="__onRemoveItemTap" class="btn-remove">Hapus Item</paper-button>
                                                </div>
                                            </kct-hbox>
                                        </div>
                                    </div>
                                </kct-hbox>
                            </template>
                        </div>
                        
                    </div>

                </div>
                <div class="page" name="penilaian">
                    Penilaian
                </div>
            </kct-pages>
        </div>

        

    </template>
    <script>
        class FormSkp extends FormBase {
            static get is() {
                return 'form-skp';
            }

            static get properties() {
                return {
                    page: { type: String, value: 'dokumen' },
                    units: { type: Array, value: () => ([]) }
                }
            }

            static get observers() {
                return [
                    '__validationChanged(record.task.skp_su_id, record.task.skp_start_date, record.task.skp_end_date)',
                    '__periodChanged(record.task.skp_start_date, record.task.skp_end_date)'
                ];
            }

            constructor() {
                super();
                this.__duration = null;
            }

            initialize() {

                if (this.action == 'create') {

                    let today = moment(),
                        startDate = today.clone().startOf('year'),
                        endDate = today.clone().endOf('year');

                    if ( ! this.$['combo-user']) {
                        this.$['combo-user'] = this.shadowRoot.querySelector('#combo-user');
                    }

                    if ( ! this.$['combo-examiner']) {
                        this.$['combo-examiner'] = this.shadowRoot.querySelector('#combo-examiner');
                    }

                    if ( ! this.$['combo-superior']) {
                        this.$['combo-superior'] = this.shadowRoot.querySelector('#combo-superior');
                    }

                    // resolve dependencies
                    return Promise.all([
                        this.__loadUnits(),
                        this.$['combo-user'].load(),
                        this.$['combo-examiner'].load(),
                        this.$['combo-superior'].load()
                    ]).then(() => {
                        this.set('buttons', 'save');
                        this.set('page', 'dokumen');

                        this.set('record.task.skp_start_date', startDate.format('YYYY-MM-DD'));
                        this.set('record.task.skp_end_date', endDate.format('YYYY-MM-DD'));
                    });
                } else {
                    return this.__loadUnits().then(() => {
                        this.set('buttons', 'save,remove');
                    });
                }
            }

            afterSave(res) {
                if (res.success) {
                    this.set('record.items', res.data.items);
                }
            }

            __computeDurations() {
                if (this.__duration == null) {
                    if (this.record.task.skp_start_date && this.record.task.skp_end_date) {
                        let start = moment(this.record.task.skp_start_date);
                        let end = moment(this.record.task.skp_end_date);
                        let diff = end.diff(start);
                        this.__duration = parseInt(end.diff(start, 'months'), 10) + 1;

                    }
                }
                return this.__duration;
            }

            __loadUnits() {
                return this.$.ajax.GET('/units').then(res => {
                    this.set('units', res.data);
                });
            }

            __periodChanged(start, end) {
                this.set('__duration', null);
            }

            __validationChanged(user, startDate, endDate) {
                let valid = true;
                
                valid = valid && !!user;
                valid = valid && !!startDate;
                valid = valid && !!endDate;

                this.set('invalid', !valid);
            }

            __addItem() {
                let value = this.$.input.value;
                if (value) {

                    if (/lorem/.test(value)) {
                        value = 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua';
                    }

                    let duration = this.__computeDurations();

                    this.unshift('record.items', {
                        ski_seq: ((this.record.items || []).length + 1),
                        ski_desc: value,
                        ski_text: value,
                        ski_volume: 1,
                        ski_volume_real: 1,
                        ski_unit: 'dokumen',
                        ski_cost: 0,
                        ski_cost_real: 0,
                        ski_duration: duration,
                        ski_duration_real: duration,
                        ski_duration_unit: 'bln',
                        ski_quality: 100,
                        ski_quality_real: 100,
                        ski_ak: 0,
                        ski_ak_real: 0,
                        ski_ak_factor: 0,
                        ski_extra: 0,
                        ski_expand: false
                    });

                    
                }
                this.$.input.value = '';
            }

            __onRemoveItemTap(e) {
                let index = e.model.index;
                this.splice('record.items', index, 1);
            }

            __onAddTaskTap() {
                this.__addItem();
                this.$.input.focus();
            }

            __onComboUserChange(e) {
                let user = e.target.getModelForValue(e.target.value);

                if (user) {
                    this.set('record.task.skp_su_no', user.su_no);
                    this.set('record.task.skp_su_grade', user.su_grade);
                    this.set('record.task.skp_su_sdp_name', user.su_sdp_name);
                    this.set('record.task.skp_su_sj_name', user.su_sj_name);
                } else {
                    this.set('record.task.skp_su_no', '');
                    this.set('record.task.skp_su_grade', '');
                    this.set('record.task.skp_su_sdp_name', '');
                    this.set('record.task.skp_su_sj_name', '');
                }

                // define periods
                // this.$.ajax.GET('/skp/info', { info: 'period' })
            }

            __onLookupTap(e) {
                if ( ! this.$['lookup-items']) {
                    Polymer.importHref(this.resolveUrl('../plugins/lookup-items.html'), () => {
                        let lov = document.createElement('lookup-items');

                        lov.addEventListener('beforeload', e => {
                            let options = e.detail.options;
                            options.lookup = 'skp';

                            let params = {};

                            if (this.record.task.skp_su_id) {
                                params.lkh_su_id = this.record.task.skp_su_id;
                            }

                            if (this.record.task.skp_start_date && this.record.task.skp_end_date) {
                                params.lkh_date = ['BETWEEN', [this.record.task.skp_start_date, this.record.task.skp_end_date]];
                            }

                            options.params = params;
                        });

                        lov.addEventListener('close', () => {
                            lov.selection.forEach(item => {

                                this.unshift('record.items', {
                                    ski_seq: ((this.record.items || []).length + 1),
                                    ski_desc: item.lki_desc,
                                    ski_text: item.lki_desc,
                                    ski_volume: item.lki_volume,
                                    ski_volume_real: item.lki_volume,
                                    ski_unit: item.lki_unit,
                                    ski_quality: 100,
                                    ski_quality_real: 100,
                                    ski_cost: item.lki_cost,
                                    ski_cost_real: item.lki_cost,
                                    ski_duration: item.lki_duration,
                                    ski_duration_real: item.lki_duration,
                                    ski_duration_unit: item.lki_duration_unit,
                                    ski_ak: 0,
                                    ski_ak_real: 0,
                                    ski_ak_factor: 0,
                                    ski_extra: 0,
                                    ski_expand: false
                                });

                            });
                        });

                        this.shadowRoot.appendChild(lov);
                        lov.open();
                        this.$['lookup-items'] = lov;
                    });    
                } else {
                    this.$['lookup-items'].open();
                }
                
            }

            __onTaskItemToggle(e) {
                let model = e.model.item;
                this.set('record.items.' + e.model.index + '.ski_expand', !model.ski_expand);
            }

            __onTaskItemChange(e) {
                let text = e.target.textContent;
                this.set('record.items.' + e.model.index + '.ski_desc', text);
            }

            __onTaskInputKeydown(e) {
                if (e.code == 'Enter') {
                    this.__addItem();
                }
                
            }
        }
        customElements.define(FormSkp.is, FormSkp);
    </script>
</dom-module>