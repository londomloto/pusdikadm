
<dom-module id="form-lkh">
    <template>
        <style include="form-style">
            .input-task {
                margin: 15px 0 5px 0;
                padding: 14px;
                background-color: var(--paper-grey-100);
                border-radius: 3px;
            }
            .input-task paper-input {
                
            }
            .task-item {
                padding: 15px 15px 15px 6px;
                background-color: var(--paper-grey-200);
                border-radius: 3px;
            }
            .task-item .icon {
                width: 40px; 
                cursor: pointer;
            }
            .task-item .icon paper-icon-button {
                position: relative;
                top: -8px;
            }
            .task-item + .task-item {
                margin-top: 5px;
            }
            .task-item-detail {
                margin-top: 15px;
                
                --paper-input-container-underline: {
                    border-color: var(--paper-grey-400);
                };
            }
            .task-item-detail kct-combobox {
                padding: 2px 0;
                --paper-input-container-label-floating: {
                    top: 8px;
                };
            }
        </style>

        <kct-ajax id="ajax"></kct-ajax>

        <div class="section">
            <h3 class="section-title">Kegiatan Harian</h3>
            <div>
                <kct-combobox 
                    id="combo-user" 
                    label="Identitas Pegawai" 
                    value="{{ record.task.lkh_su_id }}" 
                    url="/users" 
                    page-size="10" 
                    item-label-path="su_fullname" 
                    item-value-path="su_id" 
                    on-change="__onComboUserChange"></kct-combobox>

                <kct-column columns="2">
                    <div>
                        <paper-input label="No. Induk Pegawai" value="[[ record.task.lkh_su_no ]]"></paper-input>
                    </div>
                    <div>
                        <paper-input label="Pangkat/Gol. Ruang" value="[[ record.task.lkh_su_grade ]]"></paper-input>
                    </div>
                </kct-column>
                
                <paper-input label="Jabatan" value="[[ record.task.lkh_su_sj_name ]]"></paper-input>
                <paper-input label="Unit Kerja" value="[[ record.task.lkh_su_sdp_name ]]"></paper-input>

                <kct-column columns="2">
                    <div>
                        <kct-combobox 
                            id="combo-presence" 
                            label="Referensi absensi" 
                            value="{{ record.task.lkh_tpr_id }}" 
                            url="/presence" 
                            page-size="10" 
                            item-label-path="tpr_date_formatted" 
                            item-value-path="tpr_id" 
                            on-change="__onComboPresenceChange"></kct-combobox>
                    </div>
                    <div>
                        <paper-input label="Tanggal Kegiatan" value="{{ record.task.lkh_date_formatted }}"></paper-input>
                    </div>
                </kct-column>
                
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Daftar Kegiatan</h3>
            <div>Tambahkan kegiatan-kegiatan yang Anda lakukan pada kolom di bawah ini.</div>
            <div class="input-task">
                <paper-input on-keydown="__onInputKeydown" placeholder="Tulis kegiatan di sini kemudian tekan enter..." no-label-float></paper-input>
            </div>
            <div class="task-list">
                <template is="dom-repeat" items="[[ record.items ]]">
                    <kct-hbox class="task-item">
                        <div class="icon">
                            <paper-icon-button on-tap="__onRemoveItemTap" icon="close"></paper-icon-button>
                        </div>
                        <div class="flex">
                            <div>[[ item.lki_desc ]]</div>
                            <kct-hbox class="task-item-detail">
                                <div class="flex p-r-sm">
                                    <paper-input label="Volume" value="{{ item.lki_volume }}" always-float-label></paper-input>
                                </div>
                                <div class="flex p-l-sm p-r-sm">
                                    <kct-combobox 
                                        label="Satuan" 
                                        value="{{ item.lki_unit }}"
                                        items="[[ units ]]" 
                                        item-label-path="sun_name" 
                                        item-value-path="sun_name"  
                                        always-float-label></kct-combobox>
                                </div>
                                <div class="flex p-l-sm">
                                    <paper-input label="Biaya" value="{{ item.lki_cost }}" always-float-label></paper-input>
                                </div>
                            </kct-hbox>
                        </div>
                    </kct-hbox>
                </template>
            </div>
            
        </div>

    </template>
    <script>
        class FormLkh extends FormBase {
            static get is() {
                return 'form-lkh';
            }

            static get properties() {
                return {
                    units: { type: Array, value: () => ([]) }
                }
            }

            static get observers() {
                return [
                    '__validationChanged(record.task.lkh_su_id)'
                ];
            }

            initialize() {

                this.$.ajax.GET('/units').then(res => {
                    this.set('units', res.data);
                });

                this.$['combo-user'].load();

                if (this.action == 'create') {
                    this.set('buttons', 'save');
                } else {
                    this.set('buttons', 'save,remove');
                }

                return this.resolve({ success: true });
            }

            __validationChanged(user) {
                let valid = true;
                valid = valid && !!user;
                this.set('invalid', !valid);
            }

            __onRemoveItemTap(e) {
                let index = e.model.index;
                this.splice('record.items', index, 1);
            }

            __onComboUserChange(e) {
                let user = e.target.getModelForValue(e.target.value);

                if (user) {
                    this.set('record.task.lkh_su_no', user.su_no);
                    this.set('record.task.lkh_su_grade', user.su_grade);
                    this.set('record.task.lkh_su_sdp_name', user.su_sdp_name);
                    this.set('record.task.lkh_su_sj_name', user.su_sj_name);
                } else {
                    this.set('record.task.lkh_su_no', '');
                    this.set('record.task.lkh_su_grade', '');
                    this.set('record.task.lkh_su_sdp_name', '');
                    this.set('record.task.lkh_su_sj_name', '');
                }

                this.$['combo-presence'].load({
                    params: {
                        tpr_su_id: user ? user.su_id : -1
                    }
                });
            }

            __onComboPresenceChange(e) {
                let presence = e.target.getModelForValue(e.target.value);

                if (presence) {
                    this.set('record.task.lkh_date', presence.tpr_date);
                    this.set('record.task.lkh_date_formatted', presence.tpr_date_formatted);
                } else {
                    this.set('record.task.lkh_date', null);
                    this.set('record.task.lkh_date_formatted', null);
                }
            }

            __onInputKeydown(e) {
                if (e.code == 'Enter') {
                    let value = e.target.value;
                    if (value) {

                        if (/lorem/.test(value)) {
                            value = 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua';
                        }

                        this.unshift('record.items', {
                            lki_desc: value,
                            lki_unit: 'dokumen',
                            lki_cost: 0,
                            lki_volume: 1
                        });
                    }
                    //e.target.focus();
                    e.target.value = '';
                }
                
            }
        }
        customElements.define(FormLkh.is, FormLkh);
    </script>
</dom-module>