<dom-module id="form-pendaftaran-conf">
    <template>
        <style include="form-style"></style>

        <kct-ajax id="ajax"></kct-ajax>

        <div class="section section-primary">
            <h3 class="section-title">Data Konfirmasi</h3>
            <div>
                <p>Menunggu konfirmasi dari peserta. Jika dalam beberapa waktu tidak ada konfirmasi, lakukan konfirmasi ulang dengan menekan tombol di bawah.</p>
                <div class="m-t">
                    <paper-button class="btn-cyan" on-tap="__onInviteTap">Kirim Ulang Konfirmasi</paper-button> 
                    <span>atau lakukan <a on-tap="__onActivateTap" href="javascript:;">aktivasi manual</a></span>
                </div>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Data Peserta</h3>
            <div>
                <paper-input label="Nama Lengkap *" value="{{ record.task.su_fullname }}" required auto-validate error-message="Nama lengkap wajib diisi"></paper-input>
                <paper-input label="Jenis Kelamin" value="{{ record.task.su_sex }}"></paper-input>

                <kct-column columns="2">
                    <div>
                        <paper-input label="Tempat Lahir" value="{{ record.task.su_pob }}"></paper-input>
                    </div>
                    <div>
                        <vaadin-date-picker label="Tanggal Lahir" value="{{ record.task.su_dob }}"></vaadin-date-picker>
                    </div>
                </kct-column>

                <paper-input label="No. Induk Pagawai" value="{{ record.task.su_no }}"></paper-input>
                <paper-input label="Pangkat / Gol. Ruang" value="{{ record.task.su_grade }}"></paper-input>
                
                <kct-combobox 
                    url="/jobs" 
                    label="Jabatan (Pekerjaan)" 
                    value="{{ record.task.su_sj_id }}" 
                    page-size="10" 
                    item-label-path="sj_name" 
                    item-value-path="sj_id"></kct-combobox>

                <kct-combobox 
                    url="/departments" 
                    label="Unit Kerja" 
                    value="{{ record.task.su_sdp_id }}" 
                    page-size="10" 
                    item-label-path="sdp_name" 
                    item-value-path="sdp_id"></kct-combobox>
                <kct-combobox 
                    url="/company" 
                    label="Organisasi" 
                    value="{{ record.task.su_scp_id }}" 
                    page-size="10" 
                    item-label-path="scp_name" 
                    item-value-path="scp_id"></kct-combobox>

            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Data Akun</h3>
            <div>
                <paper-input type="email" label="Alamat Email *" value="{{ record.task.su_email }}" required auto-validate error-message="Alamat email harus valid"></paper-input>
                <kct-combobox 
                    url="/roles" 
                    label="Group Akses (Role) *" 
                    value="{{ record.task.su_sr_id }}" 
                    page-size="10" 
                    item-label-path="sr_name" 
                    item-value-path="sr_id" 
                    required 
                    auto-validate 
                    error-message="Group akses wajib diisi" 
                    autoload></kct-combobox>
            </div>
        </div>

    </template>
    <script>
        class FormPendaftaranConf extends FormBase {
            static get is() {
                return 'form-pendaftaran-conf';
            }

            static get observers() {
                return [
                    '__validationChanged(record.task.su_fullname, record.task.su_email, record.task.su_sr_id)'
                ];
            }

            initialize() {
                if (this.action == 'create') {
                    this.set('buttons', 'save');
                } else {
                    this.set('buttons', 'save,send,remove');    
                }
                
                this.shadowRoot.querySelectorAll('kct-combobox[page-size]').forEach(c => c.load());
                return this.resolve();
            }

            save(options) {
                if (options.send) {
                    // send invitation email
                    return this.$.ajax.POST('/users/invite', {
                        email: this.record.task.su_email,
                        role: this.record.task.sr_id
                    });
                } else {
                    return this.resolve({ success: true });    
                }
            }

            __validationChanged(fullname, email, role) {
                let valid = true;

                valid = valid && fullname;
                valid = valid && email;
                valid = valid && role;

                this.set('invalid', !valid);
            }

            __onInviteTap() {
                let payload = {
                    email: this.record.task.su_email
                };

                this.$.ajax.POST('/users/reinvite', payload).then(res => {
                    this.toast('Success', 'Permintaan konfirmasi sudah dikirim');
                });
            }

            __onActivateTap() {
                this.confirm('Konfirmasi', 'Lakukan konfirmasi manual?').then(y => {
                    if (y) {
                        let payload = this.record.task;
                        this.trigger('before-update');

                        this.$.ajax.POST('/users/activate', payload).then(() => {
                            this.trigger('after-update', { back: true });
                        });
                    }
                });
                
            }
        }
        customElements.define(FormPendaftaranConf.is, FormPendaftaranConf);
    </script>
</dom-module>