<link rel="import" href="../../../../../cores/elements/kct-view/kct-view.html">
<link rel="import" href="../../../../../cores/elements/kct-grid/kct-grid.html">
<link rel="import" href="../../../../../cores/elements/kct-ajax/kct-ajax.html">
<link rel="import" href="../../../../../cores/elements/kct-event/kct-event-subscriber.html">
<link rel="import" href="../../../../../cores/mixins/mixins.html">
<link rel="import" href="../styles/project-view-grid-style.html">

<script>
    Mixins.ProjectViewGrid = Polymer.dedupingMixin(superclass => {

        return class extends superclass {

            static get properties() {
                return {
                    busy: { type: Boolean, value: false, notify: true },
                    project: { type: String },
                    projectRecord: { type: Object },
                    params: { type: Object },
                    columns: {
                        type: Array,
                        value: () => ([
                            { type: 'rownumber', width: 44 },
                            /*{
                                type: 'action',
                                width: 50,
                                align: 'center',
                                renderer: (e) => {
                                    if (e.data) {
                                        return '<kct-grid-action accent="pink" icon="image:edit" on-tap="__onEditTap" icon-only rounded></kct-grid-action>';
                                    }
                                    return '';
                                }
                            },*/
                            { 
                                text: 'Keterangan', 
                                width: 367,
                                dataIndex: 'tt_title',
                                renderer: (e) => {
                                    if (e.data) {
                                        return `
                                            <div class="item-title">${e.data.tt_title}</div>
                                            <div class="item-meta">Dibuat oleh <b>${e.data.creator_su_fullname}</b> ${e.data.tt_created_dt_formatted}</div>
                                        `;
                                    }
                                    return '';
                                }
                            },
                            { 
                                text: 'Deadline',
                                dataIndex: 'tt_due_date',
                                renderer: (e) => {
                                    if (e.data) {
                                        return e.data.tt_due_date_formatted;
                                    }
                                    return '';
                                }
                            },
                            { 
                                text: 'Status',
                                type: 'action',
                                renderer: (e) => {
                                    if (e.data) {
                                        let div = '';
                                        e.data.statuses.forEach(s => {
                                            div += `<a 
                                                on-tap="__onTaskStatusTap" 
                                                title="Update task" 
                                                data-status="${s.tts_id}" 
                                                href="javascript:;" 
                                                class="item-badge" 
                                                style="background-color: ${s.status_color};">${s.status_text}</a>`;
                                        });
                                        return div;
                                    }
                                    return '';
                                }
                            }
                        ])
                    }
                };
            }

            static get observers() {
                return [
                    '__projectChanged(project)',
                    '__paramsChanged(params.*)'
                ];
            }

            handleRouteParams(project, action, type) {
                if (project === undefined  || project == 'tour' || project == 'create') return;
                if (action != 'view') return;
                if (type != 'list') return;

                if (this.$.grid) {
                    let resizing = setTimeout(() => {
                        clearTimeout(resizing);
                        resizing = null;
                        this.$.grid.resize();
                        this.set('project', project);
                    }, 10);
                }
            }

            handleResizing() {
                if (this.$.grid) {
                    this.$.grid.resize();
                }
            }

            reload() {
                return this.__loadGrid();
            }
            
            __projectChanged(project) {
                if (project) {
                    this.__loadProject();
                    this.__loadGrid();
                }
            }

            __paramsChanged(changed) {
                if (changed.path == 'params') {
                    this.reload();
                }
            }

            __loadProject() {

                this.set('projectRecord', null);
                
                if ( ! this.project) return;
                
                this.$.ajax.GET('/projects/' + this.project + '/load').then(res => {
                    this.set('projectRecord', res.data);
                    this.__loadGrid();
                });
            }

            __loadGrid() {
                this.set('busy', true);

                if ( ! this.projectRecord) {
                    this.set('busy', false);
                    return Promise.resolve;
                }

                let grid = this.$.grid;
                let params = Object.assign({}, this.params);
                
                params.project = this.projectRecord.sp_id;

                grid.params = params;

                return grid.load().then(() => {
                    this.set('busy', false);
                    return;
                });
            }

            __onNotify() {
                this.reload();
            }

            __onTaskStatusTap(args) {
                let btn = (args.event.path || [])[0];
                let status = btn && btn.dataset.status;
                if (status) {
                    this.set('route.data.back', '/worksheet/' + this.project + '/view/list');
                    this.set('route.path', '/worksheet/' + this.project + '/task/update/' + status);
                }
            }

            __onEditTap(e) {
                let data  = e.data;
                if (data.statuses && data.statuses.length) {
                    let status = data.statuses[0];
                    this.set('route.data.back', '/worksheet/' + this.project + '/view/list');
                    this.set('route.path', '/worksheet/' + this.project + '/task/update/' + status.tts_id);
                }
            }

        }

    });
</script>