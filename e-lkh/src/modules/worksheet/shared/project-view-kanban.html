<link rel="import" href="../../../../../cores/elements/kct-view/kct-view.html">
<link rel="import" href="../../../../../cores/elements/kct-ajax/kct-ajax.html">
<link rel="import" href="../../../../../cores/elements/kct-worksheet/kct-worksheet.html">
<link rel="import" href="../../../../../cores/elements/kct-event/kct-event-subscriber.html">
<link rel="import" href="../../../../../cores/mixins/mixins.html">
<link rel="import" href="../styles/project-view-kanban-style.html">

<script>
    Mixins.ProjectViewKanban = Polymer.dedupingMixin(superclass => {

        return class extends superclass {

            static get properties() {
                return {
                    project: { type: String },
                    projectRecord: { type: Object },
                    worksheetRecord: { type: Object },
                    workspaces: { type: Array },
                    workspaceRecord: { type: Object },
                    params: { type: Object },
                    busy: { type: Boolean, value: false, notify: true },
                    pageSize: { type: Number, value: 5 },
                    maxPageSize: { type: Number, value: 100 }
                };
            }

            static get observers() {
                return [
                    '__projectChanged(project)',
                    '__paramsChanged(params.*)'
                ];
            }

            constructor() {
                super();
                this.__paging = {};
            }

            handleRouteParams(project, action, type) {
                if (project === undefined  || project == 'tour' || project == 'create') return;
                if (action != 'view') return;
                if (type != 'kanban') return;
                
                this.set('project', project);
            }

            handleResizing(width, height) {
                if (this.$.worksheet) {
                    this.$.worksheet.resize();
                }
            }

            reload() {
                return this.__loadWorksheet();
            }

            __projectChanged(project) {
                if (project) {
                    this.__loadProject();
                }
            }

            __paramsChanged(changed) {
                if (changed.path == 'params') {
                    this.reload();
                }
            }

            __loadProject() {
                if ( ! this.project) return;
                
                this.$.ajax.GET('/projects/' + this.project + '/load').then(res => {
                    this.set('projectRecord', res.data);
                    this.__loadWorksheet();
                });
            } 

            __loadWorksheet() {
                this.set('busy', true);
                this.set('workspaces', []);

                if ( ! this.projectRecord) {
                    this.set('busy', false);
                    this.set('worksheetRecord', {});
                    return;
                }

                this.__loader = this._defer();

                this.__loader.promise.then(() => {
                    this.set('busy', false);
                    this.$.worksheet.resize();
                });

                let sheet = this.projectRecord && this.projectRecord.sp_worksheet_id;

                if (sheet) {
                    this.$.ajax.GET('/kanban/kanban-settings/' + sheet, { 
                        request: 'granted',
                        project: this.projectRecord.sp_id
                    }).then(res => {
                        let data = res.data || {};

                        // kurangi kesan loading disini...
                        if (this.worksheetRecord) {
                            let cached = {};
                            
                            this.worksheetRecord.ks_panels.forEach(p => {
                                cached[p.kp_id] = p.kp_data;
                            });

                            (data.ks_panels || []).forEach(p => {
                                if (cached[p.kp_id] !== undefined) {
                                    p.kp_data = cached[p.kp_id];
                                }
                            });

                            cached = null;
                        }

                        this.set('worksheetRecord', data);
                                
                        this.__loadWorkspaces();
                        this.__loadPanels();

                    });
                } else {
                    this.set('worksheetRecord', {});
                }

                return this.__loader.promise;
            }

            __loadWorkspaces() {
                this.set('workspaces', []);

                if ( ! this.worksheetRecord) {
                    return;
                }

                let sheet = this.worksheetRecord.ks_id;

                this.$.ajax.GET('/kanban/kanban-workspaces?kanban=' + sheet).then(res => {
                    this.set('workspaces', res.data);
                });
            }

            __loadPanels() {
                let panels = this.worksheetRecord.ks_panels;
                let count = panels.length;
                let index = 0;

                if ( ! count) {
                    this.__loader.resolve();
                } else {
                    panels.forEach(p => {
                        this.__loadPanelData(p).then(() => {
                            index++;
                            if (index === count) {
                                this.__loader.resolve();
                            }
                        });
                    });
                }
            }

            __loadPanelData(panel, options = {}) {
                let statuses = (panel.kp_statuses || []).map(s => s.kst_status),
                    index = (this.worksheetRecord.ks_panels || []).indexOf(panel),
                    defer = this._defer();

                let payload = Object.assign({}, this.params, options);

                payload.statuses = JSON.stringify(statuses);
                payload.project = this.projectRecord.sp_id;

                let paging = this.__getPaging(panel);

                if (payload.start === undefined) {
                    payload.start = paging.__start;
                }

                if (payload.limit === undefined) {
                    payload.limit = paging.__limit;
                }

                if (payload.start == 0 && payload.limit > this.maxPageSize) {
                    payload.limit = this.maxPageSize;

                    this.__setPaging(panel, { 
                        __start: 0,
                        __limit: payload.limit 
                    });
                }

                this.set('worksheetRecord.ks_panels.' + index + '.kp_busy', true);
                
                this.$.ajax.GET(this.metadata.service_url, payload).then((res) => {
                    let items;

                    if (payload.start == 0) {
                        items = res.data;
                    } else {
                        items = (this.worksheetRecord.ks_panels[index].kp_data || []).slice();
                        Array.prototype.push.apply(items, res.data);
                    }
                        
                    this.set('worksheetRecord.ks_panels.' + index + '.kp_data', items);
                    this.set('worksheetRecord.ks_panels.' + index + '.kp_busy', false);

                    let count = items.length,
                        total = +res.total;

                    if (count >= res.total) {
                        this.set('worksheetRecord.ks_panels.' + index + '.kp_more', false);
                    } else {
                        this.set('worksheetRecord.ks_panels.' + index + '.kp_more', true);
                    }

                    this.__setPaging(panel, {
                        start: payload.start + payload.limit,
                        limit: this.pageSize,
                        __start: 0,
                        __limit: count > this.pageSize ? count : this.pageSize
                    });

                    defer.resolve();
                    
                });

                return defer.promise;
            }

            __setPaging(panel, params) {
                let paging = this.__getPaging(panel);
                Object.assign(paging, params);
            }

            __getPaging(panel) {
                let token = 'panel_' + this.projectRecord.sp_id + '_' + panel.kp_id;

                if (this.__paging[token] === undefined) {
                    this.__paging[token] = {
                        // load more paging
                        start: 0,
                        limit: this.pageSize,

                        // reload paging
                        __start: 0,
                        __limit: this.pageSize
                    };
                }

                return this.__paging[token];
            }

            __onCardItemTap(e) {
                let record = e.model.item;
                
                this.set('route.data.back', '/worksheet/' + this.project + '/view/kanban');
                this.set('route.path', '/worksheet/' + this.project + '/task/update/' + record.status[this.metadata.status_primary_key]);
            }

            __onNotify() {
                this.reload();
            }

            __onLoadMoreTap(e) {
                let paging = this.__getPaging(e.model.panel);

                if (paging) {
                    this.set('busy', true);

                    this.__loadPanelData(e.model.panel, {
                        start: paging.start,
                        limit: paging.limit
                    }).then(() => {
                        this.set('busy', false);
                        this.$.worksheet.resize();
                    });
                }
            }

        }

    });
</script>