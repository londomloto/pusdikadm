<link rel="import" href="../../mixins/resolver.html">
<link rel="import" href="../kct-layouts/kct-vbox.html">
<link rel="import" href="../kct-worksheet/kct-worksheet-panel.html">
<link rel="import" href="../kct-media/kct-media.html">

<dom-module id="kct-worksheet">
    <template>
        <style>
            :host { 
                display: block;
                height: 100%; 
            }

            .kanban {
                background-color: var(--paper-grey-100);
            }

            .kanban::before {
                /*content: '';
                position: absolute;
                left: 0;
                right: 0;
                height: 46px;
                background-color: #f9f9f9;*/
                /*top: 99px;
                border-bottom: 1px solid #eee;*/
            }
            
            .kanban-header {
                padding: 0 6px;
                background-color: var(--kanban-header-background, var(--paper-blue-grey-500));
                color: var(--kanban-header-color, #ffffff);
            }

            .kanban-body {
                padding: 0;
                overflow: auto;
            }

            .kanban-body-top-space {
                height: 18px;
                width: 100%;
                background-color: #fff;
            }
            .panel-container {
                height: 100%;
            }
            .panel-container ::slotted(kct-worksheet-panel:nth-child(even)) {
                --panel-body-background: #f9f9f9;
            }
        </style>

        <kct-media size="{{ responsive }}"></kct-media>

        <kct-vbox class="kanban">
            <div class="kanban-header">
                <slot name="header"></slot>        
            </div>
            <div id="kanban-body" class="kanban-body flex">
                <div id="panel-container" class="panel-container">
                    <slot id="panel"></slot>
                </div>
            </div>
        </kct-vbox>
    </template>
    <script>
        class KctWorksheet extends Mixins(Polymer.Element).use(Mixins.Resolver) {
            static get is() {
                return 'kct-worksheet';
            }
            static get properties() {
                return {
                    columns: { type: Number, value: 3 },
                    responsive: { type: Number }
                };
            }
            static get observers() {
                return [
                    '__columnsChanged(columns)',
                    '__responsiveChanged(responsive)'
                ];
            }
            constructor() {
                super();
                this.__columns = null;
            }
            resize() {
                this.__resizePanelContainer();
            }
            scroll(dir) {
                switch(dir) {
                    case 'right':
                        let timer = setTimeout(() => {
                            this.$['kanban-body'].scrollLeft = this.$['kanban-body'].scrollWidth;
                            clearTimeout(timer);
                            timer = null;
                        }, 0);
                        break;
                    case 'left':
                        this.$['kanban-body'].scrollLeft = 0;
                        break;
                }
            }
            __columnsChanged(columns) {
                if (columns !== undefined && this.__columns === null) {
                    this.__columns = columns;
                }
            }
            __responsiveChanged(size) {
                switch(size) {
                    case 'sm':
                    case 'md':
                        this.set('columns', 1);
                        break;
                    case 'lg':
                        this.set('columns', 2);
                        break;
                    case 'xl':
                        this.set('columns', this.__columns);
                        break;
                }
            }
            __getBodySize() {
                let elem = this.$['kanban-body'];

                let size = {
                    width: elem.clientWidth,
                    height: elem.clientHeight
                }

                return size;
            }
            __getScrollbarHeight() {
                let height = this.constructor.__scrollbarHeight;

                if (height === undefined) {
                    let outer, inner, width1, width2;
                    
                    outer = document.createElement('div');
                    outer.style.visibility = 'hidden';
                    outer.style.width = '100px';
                    outer.style.msOverflowStyle = 'scrollbar';
                    
                    document.body.appendChild(outer);
                    
                    width1 = outer.offsetWidth;

                    outer.style.overflow = 'scroll';

                    inner = document.createElement('div');
                    inner.style.width = '100%';
                    
                    outer.appendChild(inner);

                    width2 = inner.offsetWidth;

                    outer.parentNode.removeChild(outer);

                    height = width1 - width2;
                    this.constructor.__scrollbarHeight = height;
                }

                return height;
            }
            __resizePanelContainer() {

                this.__resizing = Polymer.Debouncer.debounce(
                    this.__resizing,
                    Polymer.Async.timeOut.after(300),
                    resize.bind(this)
                );

                Polymer.enqueueDebouncer(this.__resizing);

                function resize() {

                    // let gutter = 15;
                    let gutter = 0;

                    let panels = this.$.panel.assignedNodes().filter(node => { return node.localName == 'kct-worksheet-panel'; }),
                        sizes = this.__getBodySize(),
                        columnWidth = ((sizes.width - this.columns * gutter) - gutter) / this.columns,
                        totalWidth = 0;
                        
                    let columnHeight = sizes.height;

                    panels.forEach(panel => {
                        if (panel.clientHeight > columnHeight) {
                            columnHeight = panel.clientHeight;
                        }
                        totalWidth += (columnWidth + gutter);
                    });

                    panels.forEach(panel => {
                        panel.width = columnWidth;
                        panel.height = columnHeight;
                    });

                    totalWidth += gutter;

                    this.$['panel-container'].style.width = totalWidth + 'px';
                    this.$['panel-container'].style.minHeight = columnHeight + 'px';
                }

                
            }
        }
        customElements.define(KctWorksheet.is, KctWorksheet);
    </script>
</dom-module>