<link rel="import" href="../kct-ajax/kct-ajax.html">

<dom-module id="kct-feed">
    <template>
        <style>
            
            .hbox {
                @apply --layout-horizontal;
            }
            .flex {
                @apply --layout-flex;
            }
            paper-button {
                color: #fff;
                background-color: var(--paper-blue-500);
                font-size: 14px;
                font-weight: normal;
            }
            :host {
                position: fixed;
                bottom: 0;
                width: 100%;
                box-sizing: border-box;
                padding: 10px;
                display: none;
                background-color: var(--paper-grey-200);
                font-family: 'Segoe UI', Roboto, Arial, sans-serif;
                z-index: 2;
            }
            :host([opened]) {
                display: block;
            }
        </style>

        <kct-ajax id="ajax" config="[[ config ]]"></kct-ajax>

        <div class="hbox">
            <div class="flex" style="text-align: left;">
                Aplikasi ini memerlukan otorisasi Anda.
            </div>
            <div class="flex" style="text-align: right;">
                <paper-button hidden$="[[ authenticated ]]" on-tap="__onAuthenticateTap" id="button-authenticate">Otentifikasi</paper-button>
                <paper-button hidden$="[[ authorized ]]" on-tap="__onAuthorizeTap" id="button-authorize">Otorisasi</paper-button>
            </div>
        </div>

    </template>
    <script>
        class KctFeed extends Polymer.Element {
            static get is() {
                return 'kct-feed';
            }

            static get properties() {
                return {
                    config: { type: Object, notify: true },
                    opened: { type: Boolean, value: false, reflectToAttribute: true },
                    authorized: { type: Boolean, value: true, reflectToAttribute: true },
                    authenticated: { type: Boolean, value: true, reflectToAttribute: true }
                }
            }

            static get observers() {
                return [
                    '__configChanged(config.*)',
                    '__authChanged(authorized, authenticated)'
                ]
            }

            __authChanged(authorized, authenticated) {
                if ( ! authorized || ! authenticated) {
                    this.set('opened', true);
                }
            }

            constructor() {
                super();

                let scopes = [
                    'https://www.googleapis.com/auth/firebase',
                    'https://www.googleapis.com/auth/firebase.database',
                    'https://www.googleapis.com/auth/firebase.messaging',
                    'https://www.googleapis.com/auth/identitytoolkit',
                    'https://www.googleapis.com/auth/userinfo.email'
                ];

                this.__scopes = scopes.join(' ');
            }

            ready() {
                super.ready();

                // if (window.firebase === undefined) {
                //     let fb = document.createElement('script');
                //     fb.src = 'https://www.gstatic.com/firebasejs/4.10.1/firebase.js';
                //     fb.onload = this.__onFirebaseLoad.bind(this);
                //     document.body.appendChild(fb);
                // }
            }

            notify(payload = {}) {

                if (window.GoogleAuth === undefined) {
                    let ga = document.createElement('script');

                    ga.src = 'https://apis.google.com/js/api.js';
                    ga.defer = true;
                    ga.async = true;
                    ga.onload = _ => {
                        gapi.load('client:auth2', _ => {

                            gapi.client.init({
                                apiKey: 'AIzaSyDCHEBx3OGgnHna2iLC4qtIl5IwL9T50LE',
                                clientId: '291581890497-98g8ulajoequ35hdtvj0lgc2hr664mi3.apps.googleusercontent.com',
                                scope: this.__scopes
                            }).then( _ => {

                                window.GoogleAuth = gapi.auth2.getAuthInstance();
                                
                                GoogleAuth.isSignedIn.listen(() => {
                                    this.__authenticate();
                                });

                                this.__authenticate().then(send.bind(this));
                            });
                        });
                    };
                    document.body.appendChild(ga);
                } else {
                    this.__authenticate().then(send.bind(this));
                }

                function send() {
                    this.$.ajax.post('https://www.pusdikadm.xyz/qtool/api/feed/notify/qtool', {
                        title: 'Hei Baby',
                        body: 'I want to make love',
                        authorization: this.session.gapi_access_token
                    });
                }
            }

            __loadMessanger() {
                if (this.__messangerLoaded) {
                    return;
                }

                this.__messangerLoaded = true;

                if (window.firebase === undefined) {
                    let fb = document.createElement('script');
                    fb.src = 'https://www.gstatic.com/firebasejs/4.10.1/firebase.js';
                    fb.onload = () => {
                        this.__initMessanger();
                    };

                    document.body.appendChild(fb);
                }
            }

            __initMessanger() {
                firebase.initializeApp({
                    apiKey: "AIzaSyDKeX0MeJWB0hRcWNLhULc5bkwxKmjgovs",
                    authDomain: "pusdikadm-196510.firebaseapp.com",
                    databaseURL: "https://pusdikadm-196510.firebaseio.com",
                    projectId: "pusdikadm-196510",
                    storageBucket: "pusdikadm-196510.appspot.com",
                    messagingSenderId: "240276356095"
                });

                let messanger = this.__messanger = firebase.messaging();

                messanger.usePublicVapidKey('BNw20yrPzz1t3g1Fi1uTIsNoOD7gjYYPTrWhYLbdKgrVEsyWnj34puOFYkpH4lC_THsc5fROd5TTBeb-0oCJsLo');
                
                messanger.onMessage(payload => {
                    console.log(payload);
                });

                messanger.onTokenRefresh(() => {
                    messanger.getToken()
                        .then(refreshedToken => {
                            console.log(refreshedToken);
                        })
                        .catch(err => {

                        });
                });

                let local = false,
                    https = location.protocol == 'https:';

                if (/(\.?local|127\.|)/.test(this.config.app_host)) {
                    local = true;
                }

                if ( ! local && https) {
                    let worker = this.config.app_base + 'service-worker.js';

                    navigator.serviceWorker.register(worker).then(reg => {
                        messanger.useServiceWorker(reg);
                        this.__requestMessangerToken();
                    });
                }
            }

            __requestMessangerToken() {
                let messanger = this.__messanger;

                messanger.getToken()
                    .then(currentToken => {
                        if (currentToken) {
                            this.__sendMessangerToken(currentToken);
                        } else {
                            this.set('authorized', false);
                            this.__saveMessangerToken(false);
                        }
                    })
                    .catch(err => {
                        console.log('request token error: ' + err);
                    });
            }

            __sendMessangerToken(token) {
                if ( ! this.config.app_feed_saved) {
                    this.$.ajax.POST('/feed/register', {
                        token: token
                    }).then(res => {
                        let status = res.data.http_code;
                        if (status == 200) {
                            this.__saveMessangerToken(true);
                        } else {
                            this.__messanger.deleteToken(token);
                            this.__requestMessangerToken();
                        }
                    });
                }
            }

            __saveMessangerToken(save) {
                this.set('config.app_feed_saved', save ? 1 : 0);
            }

            __loadAuthenticator() {

            }

            __authenticate() {

                this.__authenticating = {};

                this.__authenticating.promise = new Promise(res => {
                    this.__authenticating.resolve = res;
                });

                let user = GoogleAuth.currentUser.get();

                if ( ! user.hasGrantedScopes(this.__scopes)) {
                    this.set('authenticated', false);
                } else {
                    this.set('authenticated', true);

                    let accessToken = user.getAuthResponse().access_token;
                    this.set('session.gapi_access_token', accessToken);

                    this.__authenticating.resolve();
                }

                return this.__authenticating.promise;
            }

            __configChanged(changed) {
                this.__loadMessanger();
            }

            __onFirebaseLoad() {
                firebase.initializeApp({
                    apiKey: "AIzaSyDKeX0MeJWB0hRcWNLhULc5bkwxKmjgovs",
                    authDomain: "pusdikadm-196510.firebaseapp.com",
                    databaseURL: "https://pusdikadm-196510.firebaseio.com",
                    projectId: "pusdikadm-196510",
                    storageBucket: "pusdikadm-196510.appspot.com",
                    messagingSenderId: "240276356095"
                });

                /*if (/^https/.test(location.protocol)) {
                    this.__setup();
                }*/

            }

            __setup() {

                let messaging = this.__messaging =  firebase.messaging();
                // this.__auth = firebase.auth();
                // this.__authProvider = new firebase.auth.GoogleAuthProvider();

                messaging.usePublicVapidKey('BKvx8BwtL-Y8T0SuMLszQUu6m5hj3rhf4y2A3yqB1SJxYlOdh0j__FFkHN3jtdwOobiiC2-SifcdKvYKMF1f1UA');

                messaging.onMessage(payload => {
                    console.log(payload);
                });

                messaging.onTokenRefresh(() => {
                    messaging.getToken()
                        .then(refreshedToken => {
                            console.log(refreshedToken);
                            this.__setTokenSentToServer(false);
                            this.__sendTokenToServer(refreshedToken);
                        })
                        .catch(err => {
                            console.log(err);
                            this.__setTokenSentToServer(false);
                        });
                });

                navigator.serviceWorker.register('/qtool/worker.js').then(reg => {
                    messaging.useServiceWorker(reg);
                    this.__requestToken();
                });
            }

            __requestToken() {
                let messaging = this.__messaging;

                messaging.getToken()
                    .then(currentToken => {
                        if (currentToken) {
                            this.__sendTokenToServer(currentToken);
                            // updateUIForPushEnabled(currentToken);
                        } else {
                            this.set('granted', false);
                            // permission request.
                            // updateUIForPushPermissionRequired();
                            this.__setTokenSentToServer(false);
                        }
                    })
                    .catch(err => {
                        console.log(err);
                    });
            }

            __isTokenSentToServer() {
                return this.session.feed_token_sent == 1;
            }

            __setTokenSentToServer(sent) {
                this.set('session.feed_token_sent', sent ? 1 : 0);
            }

            __sendTokenToServer(token) {
                if ( ! this.__isTokenSentToServer()) {
                    this.$.ajax.post('/api/feed/register', {
                        token: token,
                        authorization: this.session.gapi_access_token
                    }).then(res => {
                        let status = res.data.http_code;
                        if (status == 200) {
                            this.__setTokenSentToServer(true);
                        } else  {
                            this.__messaging.deleteToken(token);
                            this.__requestToken();
                        }
                    });
                }
            }

            __notify() {
                // notify all
                if (this.session.feed_authorization) {
                    this.$.ajax.post('https://www.pusdikadm.xyz/qtool/api/feed/notify/qtool', {
                        title: 'Hei Baby',
                        body: 'I want to make love',
                        authorization: this.session.feed_authorization
                    });
                }
            }

            __onAuthorizeTap() {
                let messaging = this.__messaging;

                messaging.requestPermission()
                    .then(() => {
                        this.set('granted', true);
                    });
            }

            __onAuthenticateTap() {
                GoogleAuth.signIn();
            }


        }
        customElements.define(KctFeed.is, KctFeed);
    </script>
</dom-module>